<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Vedic Astrology South Indian Chart</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f5f0e8; --surface:#fff; --card:#fdfaf5; --card2:#f0ebe0;
  --border:#d8ccb4; --border-bright:#b8a888;
  --gold:#8b6914; --gold-light:#a8821e; --gold-dim:#c4a44a;
  --accent:#4a6fa5; --accent-light:#6389bf;
  --text:#2c2416; --text-dim:#6b5b3e; --text-muted:#a8956e;
  --red:#c0392b; --green:#27ae60;
  --sun:#f39c12; --moon:#7f8c8d; --mars:#c0392b; --mercury:#27ae60;
  --jupiter:#e67e22; --venus:#e91e8c; --saturn:#5c6bc0;
  --rahu:#607d8b; --ketu:#795548;
  --shadow:0 2px 16px rgba(139,105,20,.12);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  background-image:radial-gradient(ellipse at 30% 10%,rgba(139,105,20,.06) 0%,transparent 50%);
  color:var(--text);font-family:'Crimson Pro',Georgia,serif;min-height:100vh;
  padding:20px 16px;display:flex;flex-direction:column;align-items:center;
  -webkit-tap-highlight-color:transparent;overflow-x:hidden;
}
.app-header{text-align:center;margin-bottom:20px;width:100%;max-width:600px}
.app-title{
  font-family:'Cinzel',serif;font-size:clamp(1rem,3.5vw,1.5rem);
  font-weight:700;color:var(--gold);letter-spacing:.08em;line-height:1.3;
}
.app-subtitle{font-size:.85rem;color:var(--text-muted);margin-top:4px;font-style:italic}
.app-wrap{width:100%;max-width:600px;display:flex;flex-direction:column;gap:14px}
.lang-row{display:flex;justify-content:flex-end;align-items:center;gap:8px}
.lang-label{font-size:.8rem;color:var(--text-muted)}
select#lang{
  background:var(--surface);color:var(--text);border:1px solid var(--border-bright);
  border-radius:6px;padding:5px 10px;font-family:inherit;font-size:.85rem;cursor:pointer;outline:none;
}

/* Chart */
.chart-wrap{
  position:relative;background:var(--surface);border:2px solid var(--border-bright);
  border-radius:10px;overflow:hidden;box-shadow:var(--shadow);
}
.chart-grid{
  display:grid;grid-template-columns:repeat(4,1fr);
  grid-template-rows:repeat(4,minmax(78px,1fr));
  gap:1px;background:var(--border);
  grid-template-areas:
    "pisces  aries   taurus  gemini"
    "aquarius center center  cancer"
    "capricorn center center leo"
    "sagittarius scorpio libra virgo";
  width:100%;
}
.cell{
  background:var(--card);position:relative;display:flex;flex-direction:column;
  align-items:center;justify-content:flex-start;padding:4px;min-height:78px;
  overflow:visible;transition:background .15s;
}
.cell.drop-active{background:rgba(74,111,165,.1);outline:2px dashed var(--accent-light);outline-offset:-2px}
.cell[data-sign="Pisces"]      {grid-area:pisces}
.cell[data-sign="Aries"]       {grid-area:aries}
.cell[data-sign="Taurus"]      {grid-area:taurus}
.cell[data-sign="Gemini"]      {grid-area:gemini}
.cell[data-sign="Aquarius"]    {grid-area:aquarius}
.cell[data-sign="Cancer"]      {grid-area:cancer}
.cell[data-sign="Capricorn"]   {grid-area:capricorn}
.cell[data-sign="Leo"]         {grid-area:leo}
.cell[data-sign="Sagittarius"] {grid-area:sagittarius}
.cell[data-sign="Scorpio"]     {grid-area:scorpio}
.cell[data-sign="Libra"]       {grid-area:libra}
.cell[data-sign="Virgo"]       {grid-area:virgo}
.cell-center{
  grid-area:center;background:var(--card2);display:flex;
  flex-direction:column;align-items:center;justify-content:center;gap:4px;
}
.center-line{
  font-family:'Cinzel',serif;font-size:.62rem;color:var(--text-muted);
  letter-spacing:.14em;text-transform:uppercase;
}
.yoga-badge{
  font-family:'Cinzel',serif;font-size:.56rem;color:var(--gold-dim);
  background:rgba(139,105,20,.08);border:1px solid rgba(139,105,20,.2);
  border-radius:3px;padding:1px 4px;margin-top:2px;text-align:center;
  line-height:1.3;max-width:88px;
}
.yoga-badge.detected{color:var(--gold);border-color:rgba(139,105,20,.45);background:rgba(139,105,20,.12)}
.sign-abbr{
  position:absolute;top:3px;left:4px;font-family:'Cinzel',serif;
  font-size:.6rem;font-weight:600;color:var(--text-muted);
  background:rgba(139,105,20,.07);padding:1px 4px;border-radius:3px;
  letter-spacing:.04em;cursor:default;z-index:2;user-select:none;
  transition:background .15s,color .15s;
}
.sign-abbr:hover{color:var(--gold);background:rgba(139,105,20,.15)}
.sign-abbr.hidden-label,.house-num.hidden-label{visibility:hidden}
.house-num{
  position:absolute;bottom:3px;right:4px;font-family:'Cinzel',serif;
  font-size:.6rem;color:var(--accent);font-weight:700;opacity:.75;z-index:2;
}
.planets-area{
  display:flex;flex-wrap:wrap;gap:2px;justify-content:center;
  align-items:flex-start;align-content:flex-start;
  width:100%;min-height:28px;margin-top:20px;padding:2px;
}

/* Planet chips */
.planet{
  display:inline-flex;align-items:center;gap:2px;padding:3px 7px;
  border-radius:5px;font-family:'Cinzel',serif;font-size:.68rem;font-weight:600;
  cursor:pointer;user-select:none;white-space:nowrap;
  transition:transform .12s,box-shadow .12s;
  box-shadow:0 1px 3px rgba(0,0,0,.18);position:relative;
  touch-action:none;-webkit-touch-callout:none;
  min-width:34px;justify-content:center;z-index:3;color:#fff;
}
.planet:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.22)}
.planet.dragging{opacity:.3}
.planet.Lagna{
  background:transparent!important;border:2px solid var(--gold);
  color:var(--gold)!important;font-size:.63rem;
  box-shadow:0 0 0 1px rgba(139,105,20,.2);
}
.planet.Sun     {background:var(--sun)}
.planet.Moon    {background:var(--moon)}
.planet.Mars    {background:var(--mars)}
.planet.Mercury {background:var(--mercury)}
.planet.Jupiter {background:var(--jupiter)}
.planet.Venus   {background:var(--venus)}
.planet.Saturn  {background:var(--saturn)}
.planet.Rahu    {background:var(--rahu)}
.planet.Ketu    {background:var(--ketu)}
.retro-mark{font-size:.58rem;color:#ffcccc;font-weight:900;line-height:1;margin-left:1px;vertical-align:super}
.planet.Lagna .retro-mark{color:var(--red)}
.deg-label{font-size:.55rem;opacity:.85;font-family:'Crimson Pro',serif;font-weight:400}

#drag-ghost{position:fixed;pointer-events:none;z-index:9999;opacity:.85;transform:scale(1.1);display:none}

/* Controls */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;box-shadow:var(--shadow)}
.panel-title{
  font-family:'Cinzel',serif;font-size:.72rem;font-weight:600;
  color:var(--text-muted);letter-spacing:.12em;text-transform:uppercase;margin-bottom:10px;
}
.planet-bank{
  display:flex;flex-wrap:wrap;gap:6px;justify-content:center;
  min-height:40px;padding:8px;background:var(--card2);
  border:1px dashed var(--border-bright);border-radius:8px;
  margin-bottom:10px;transition:background .15s,border-color .15s;
}
.planet-bank.drop-active{background:rgba(74,111,165,.08);border-color:var(--accent-light)}
.planet-bank .planet{font-size:.76rem;padding:5px 10px;min-width:42px}
.tip-box{
  font-size:.78rem;color:var(--text-dim);background:rgba(139,105,20,.05);
  border-left:3px solid var(--gold-dim);padding:7px 10px;border-radius:0 6px 6px 0;
  line-height:1.5;margin-top:8px;font-style:italic;
}
.btn-row{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:10px}
.btn{
  padding:7px 14px;font-family:'Cinzel',serif;font-size:.7rem;font-weight:600;
  letter-spacing:.05em;border:1px solid var(--border-bright);background:var(--surface);
  color:var(--text-dim);border-radius:6px;cursor:pointer;transition:all .15s;text-transform:uppercase;
}
.btn:hover{background:var(--card2);color:var(--text);border-color:var(--gold-dim)}
.btn.danger{border-color:rgba(192,57,43,.35);color:var(--red)}
.btn.danger:hover{background:rgba(192,57,43,.07)}
.deg-hint{font-size:.7rem;color:var(--text-muted);text-align:center;padding:4px;font-style:italic}

/* Yoga cards */
.yogas-panel{display:none;flex-direction:column;gap:6px}
.yogas-panel.visible{display:flex}
.yoga-card{
  background:var(--card2);border:1px solid var(--border);border-radius:8px;
  padding:8px 12px;display:flex;align-items:flex-start;gap:10px;
  animation:fadeIn .25s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}
.yoga-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px}
.yoga-name{font-family:'Cinzel',serif;font-size:.72rem;color:var(--gold);font-weight:600;margin-bottom:2px}
.yoga-desc{font-size:.78rem;color:var(--text-dim);line-height:1.4}
.yoga-empty{font-size:.8rem;color:var(--text-muted);text-align:center;padding:10px;font-style:italic}

/* AI prompt */
.prompt-output{
  background:var(--card2);border:1px solid var(--border);border-radius:8px;
  padding:12px;font-size:.78rem;line-height:1.65;color:var(--text);
  white-space:pre-wrap;word-break:break-word;max-height:300px;
  overflow-y:auto;font-family:'Crimson Pro',serif;
}
.prompt-output:empty::before{content:'Place Lagna and planets in the chart to generate a prompt‚Ä¶';color:var(--text-muted);font-style:italic}

.copy-toast{
  position:fixed;bottom:24px;left:50%;
  transform:translateX(-50%) translateY(60px);
  background:rgba(39,174,96,.95);color:#fff;font-family:'Cinzel',serif;
  font-size:.76rem;letter-spacing:.08em;padding:9px 20px;border-radius:24px;
  box-shadow:0 4px 18px rgba(0,0,0,.2);z-index:9999;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1),opacity .3s;
  opacity:0;pointer-events:none;
}
.copy-toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* Tabs */
.tab-row{display:flex;background:var(--card2);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.tab-btn{
  flex:1;padding:8px 6px;font-family:'Cinzel',serif;font-size:.67rem;font-weight:600;
  letter-spacing:.04em;border:none;background:transparent;color:var(--text-muted);
  cursor:pointer;transition:all .15s;text-transform:uppercase;
  border-right:1px solid var(--border);
}
.tab-btn:last-child{border-right:none}
.tab-btn.active{background:var(--surface);color:var(--gold)}
.tab-btn:hover:not(.active){background:rgba(139,105,20,.05);color:var(--text-dim)}
.tab-content{display:none}
.tab-content.active{display:block}

/* Floating panels */
.tooltip{
  position:fixed;background:rgba(255,252,245,.98);border:1px solid var(--border-bright);
  border-radius:8px;padding:10px 13px;font-size:.8rem;line-height:1.6;color:var(--text);
  z-index:5000;pointer-events:none;max-width:270px;
  box-shadow:0 6px 24px rgba(139,105,20,.18);backdrop-filter:blur(4px);display:none;
}
.tooltip.visible{display:block}
.tooltip strong{color:var(--gold);font-family:'Cinzel',serif;font-size:.76rem}
.tooltip hr{border:none;border-top:1px solid var(--border);margin:5px 0}
.tooltip .trow{display:block;margin-bottom:1px}
.tooltip .trow span{color:var(--text-muted)}

/* Retro & sign panels share base styles */
.float-panel{
  position:fixed;background:rgba(255,252,245,.99);border-radius:10px;
  z-index:5000;box-shadow:0 6px 28px rgba(139,105,20,.2);display:none;flex-direction:column;gap:10px;
}
.float-panel.visible{display:flex}
#retroPanel{border:1px solid var(--gold-dim);padding:14px;min-width:185px}
#signPanel{border:1px solid var(--border-bright);padding:12px 14px;max-width:255px;gap:4px;font-size:.8rem;line-height:1.55}
.float-panel-title{font-family:'Cinzel',serif;font-size:.76rem;color:var(--gold);font-weight:700;border-bottom:1px solid var(--border);padding-bottom:6px}
.float-panel label{display:flex;align-items:center;gap:10px;cursor:pointer;font-size:.85rem;color:var(--text)}
.float-panel input[type=checkbox]{width:17px;height:17px;accent-color:var(--gold);cursor:pointer}
.deg-input-row{display:flex;align-items:center;gap:8px;font-size:.82rem;color:var(--text-dim)}
.deg-input-row input[type=number]{
  width:68px;background:var(--card2);border:1px solid var(--border-bright);
  border-radius:5px;color:var(--text);padding:4px 8px;
  font-family:'Crimson Pro',serif;font-size:.88rem;outline:none;
}
.deg-input-row input[type=number]:focus{border-color:var(--gold-dim)}
.panel-close{
  align-self:flex-end;font-size:.68rem;color:var(--text-muted);cursor:pointer;
  padding:2px 8px;border:1px solid var(--border);border-radius:4px;font-family:'Cinzel',serif;
}
.panel-close:hover{color:var(--text)}
#signPanel strong{color:var(--gold);font-family:'Cinzel',serif;font-size:.76rem}
#signPanel hr{border:none;border-top:1px solid var(--border);margin:4px 0}

.overlay{position:fixed;inset:0;z-index:4999;display:none}
.overlay.visible{display:block}

/* Aspects */
.aspect-entry{
  margin-bottom:6px;padding:7px 10px;background:var(--card2);
  border-radius:6px;border:1px solid var(--border);
  display:flex;align-items:center;gap:8px;font-size:.78rem;
}

@media(max-width:480px){
  body{padding:10px}
  .chart-grid{grid-template-rows:repeat(4,minmax(68px,1fr))}
  .cell{min-height:68px}
  .planet{font-size:.6rem;padding:2px 5px;min-width:28px}
  .planet-bank .planet{font-size:.7rem;padding:4px 9px}
  .sign-abbr,.house-num{font-size:.54rem}
  .tab-btn{font-size:.59rem;padding:7px 3px}
}
</style>
</head>
<body>

<div id="drag-ghost"></div>
<div class="overlay" id="overlay"></div>
<div class="copy-toast" id="copyToast">‚úì Copied to clipboard!</div>

<div class="app-header">
  <div class="app-title" id="appTitle">South Indian Vedic Astrology Chart</div>
  <div class="app-subtitle" id="appSubtitle">Interactive ‚Ä¢ Drag planets into signs</div>
</div>

<div class="app-wrap">
  <div class="lang-row">
    <span class="lang-label">Language:</span>
    <select id="lang">
      <option value="en">English</option>
      <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
    </select>
  </div>

  <div class="chart-wrap">
    <div class="chart-grid" id="chartGrid">
      <!-- cells generated by JS -->
    </div>
  </div>

  <div class="panel">
    <div class="panel-title" id="bankTitle">Planet Bank ‚Äî Drag into chart</div>
    <div class="planet-bank" id="planetBank"></div>
    <div class="tip-box" id="bankTip">Drag planets from here into a chart sign box. Double-tap a placed planet to return it here. Tap once to set retrograde &amp; exact degree.</div>
    <div class="btn-row">
      <button class="btn" id="btnSigns">Hide Signs</button>
      <button class="btn" id="btnNums">Hide Numbers</button>
      <button class="btn danger" id="btnClear">Clear Chart</button>
    </div>
    <div class="deg-hint" id="degHint">Tap placed planet ‚Üí set exact degree &amp; retrograde</div>
  </div>

  <div class="panel">
    <div class="tab-row">
      <button class="tab-btn active" data-tab="yogas">‚ö° Yogas</button>
      <button class="tab-btn" data-tab="prompt">ü§ñ AI Prompt</button>
      <button class="tab-btn" data-tab="aspects">üî≠ Aspects</button>
    </div>
    <div class="tab-content active" id="tab-yogas" style="margin-top:12px">
      <div class="yogas-panel visible" id="yogasPanel"></div>
    </div>
    <div class="tab-content" id="tab-prompt" style="margin-top:12px">
      <div style="font-size:.78rem;color:var(--text-dim);line-height:1.5;font-style:italic" id="promptIntro">
        Generate a ready-to-paste prompt for any AI (ChatGPT, Claude, Gemini‚Ä¶) to get a Vedic reading.
      </div>
      <div class="prompt-output" id="promptOutput"></div>
      <div class="btn-row">
        <button class="btn" id="btnGenPrompt">‚ú® Generate Prompt</button>
        <button class="btn" id="btnCopyPrompt">üìã Copy</button>
      </div>
    </div>
    <div class="tab-content" id="tab-aspects" style="margin-top:12px">
      <div id="aspectsPanel" style="font-size:.8rem;line-height:1.6;color:var(--text-dim)"></div>
    </div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<div class="float-panel" id="retroPanel">
  <div class="float-panel-title" id="retroTitle">Planet</div>
  <label><input type="checkbox" id="retroCheck"><span id="retroLabel">Retrograde</span></label>
  <div class="deg-input-row">
    <span>Degree:</span>
    <input type="number" id="degInput" min="0" max="29.99" step="0.1" value="0">
    <span>¬∞</span>
  </div>
  <span class="panel-close" id="retroClose">Close</span>
</div>

<div class="float-panel" id="signPanel">
  <strong id="spSignName"></strong>
  <hr>
  <div id="spBody"></div>
  <span class="panel-close" id="spClose">Close</span>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SIGNS = ['Aries','Taurus','Gemini','Cancer','Leo','Virgo','Libra','Scorpio','Sagittarius','Capricorn','Aquarius','Pisces'];
const ALL_PIDS = ['Lagna','Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];

// Nakshatra: [name, lord, keywords]
const NAKSH = [
  ['Ashwini','Ketu','Speed, Healing, Initiative'],
  ['Bharani','Venus','Transformation, Patience, Sacrifice'],
  ['Krittika','Sun','Purification, Leadership, Protection'],
  ['Rohini','Moon','Growth, Fertility, Creativity'],
  ['Mrigashira','Mars','Curiosity, Searching, Wandering'],
  ['Ardra','Rahu','Transformation, Intensity, Renewal'],
  ['Punarvasu','Jupiter','Renewal, Nourishment, Return'],
  ['Pushya','Saturn','Nourishment, Protection, Spirituality'],
  ['Ashlesha','Mercury','Intuition, Hypnotic, Mysticism'],
  ['Magha','Ketu','Authority, Ancestors, Legacy'],
  ['Purva Phalguni','Venus','Enjoyment, Luxury, Romance'],
  ['Uttara Phalguni','Sun','Support, Union, Philanthropy'],
  ['Hasta','Moon','Skill, Dexterity, Craftsmanship'],
  ['Chitra','Mars','Artistry, Beauty, Architecture'],
  ['Swati','Rahu','Independence, Movement, Adaptability'],
  ['Vishakha','Jupiter','Purpose, Determination, Achievement'],
  ['Anuradha','Saturn','Devotion, Friendship, Success'],
  ['Jyeshtha','Mercury','Seniority, Protection, Power'],
  ['Moola','Ketu','Foundation, Destruction, Research'],
  ['Purva Ashadha','Venus','Invincibility, Persistence, Water'],
  ['Uttara Ashadha','Sun','Victory, Dharma, Leadership'],
  ['Shravana','Moon','Listening, Learning, Wisdom'],
  ['Dhanishta','Mars','Wealth, Rhythm, Celebration'],
  ['Shatabhisha','Rahu','Healing, Mysticism, Hidden Knowledge'],
  ['Purva Bhadrapada','Jupiter','Transformation, Spiritual Fire'],
  ['Uttara Bhadrapada','Saturn','Stability, Prosperity, Universal Love'],
  ['Revati','Mercury','Nourishment, Protection, Completion']
];

const PLANET_RULES = {
  Sun:['Leo'],Moon:['Cancer'],Mars:['Aries','Scorpio'],
  Mercury:['Gemini','Virgo'],Jupiter:['Sagittarius','Pisces'],
  Venus:['Taurus','Libra'],Saturn:['Capricorn','Aquarius'],
  Rahu:['Aquarius'],Ketu:['Scorpio']
};
const EXALT   = {Sun:'Aries',Moon:'Taurus',Mars:'Capricorn',Mercury:'Virgo',Jupiter:'Cancer',Venus:'Pisces',Saturn:'Libra',Rahu:'Taurus',Ketu:'Scorpio'};
const DEBIL   = {Sun:'Libra',Moon:'Scorpio',Mars:'Cancer',Mercury:'Pisces',Jupiter:'Capricorn',Venus:'Virgo',Saturn:'Aries',Rahu:'Scorpio',Ketu:'Taurus'};

const SIGN_DATA = {
  Aries:      ['Initiation, Action, Energy','Mars','Fire','Cardinal','‚ôà'],
  Taurus:     ['Stability, Sensuality, Comfort','Venus','Earth','Fixed','‚ôâ'],
  Gemini:     ['Communication, Intellect, Versatility','Mercury','Air','Dual','‚ôä'],
  Cancer:     ['Nurturing, Emotion, Home','Moon','Water','Cardinal','‚ôã'],
  Leo:        ['Creativity, Leadership, Royalty','Sun','Fire','Fixed','‚ôå'],
  Virgo:      ['Service, Analysis, Health','Mercury','Earth','Dual','‚ôç'],
  Libra:      ['Harmony, Relationships, Justice','Venus','Air','Cardinal','‚ôé'],
  Scorpio:    ['Transformation, Secrecy, Intensity','Mars, Ketu','Water','Fixed','‚ôè'],
  Sagittarius:['Philosophy, Exploration, Wisdom','Jupiter','Fire','Dual','‚ôê'],
  Capricorn:  ['Discipline, Ambition, Structure','Saturn','Earth','Cardinal','‚ôë'],
  Aquarius:   ['Innovation, Humanitarianism','Saturn, Rahu','Air','Fixed','‚ôí'],
  Pisces:     ['Imagination, Spirituality, Compassion','Jupiter, Ketu','Water','Dual','‚ôì']
};

const HOUSE_KW = [
  '','Self, Personality, Body, Appearance, Health',
  'Wealth, Family, Speech, Food, Values',
  'Siblings, Courage, Communication, Skills',
  'Mother, Home, Land, Vehicles, Inner Peace',
  'Children, Creativity, Intelligence, Romance',
  'Enemies, Debts, Disease, Service, Obstacles',
  'Marriage, Partnerships, Business, Spouse',
  'Longevity, Occult, Inheritance, Transformation',
  'Father, Guru, Dharma, Fortune, Spirituality',
  'Career, Status, Reputation, Authority',
  'Gains, Friends, Hopes, Community, Ambitions',
  'Losses, Expenses, Moksha, Foreign Lands'
];

// Special aspects: planet -> [relative house positions from planet's house]
const SPECIAL_ASPECTS = {Mars:[4,7,8],Jupiter:[5,7,9],Saturn:[3,7,10],Rahu:[5,7,9],Ketu:[5,7,9]};

const YOGA_DEFS = [
  {name:'Gaja Kesari Yoga',icon:'üêò',
    desc:'Jupiter and Moon in mutual kendra (1,4,7,10). Brings wisdom, fame, and prosperity.',
    check:(pd,ls)=>{
      if(!ls||!pd.Jupiter||!pd.Moon)return false;
      return [0,3,6,9].includes(Math.abs(houseOf(pd.Jupiter.sign,ls)-houseOf(pd.Moon.sign,ls)));
    }},
  {name:'Budha-Aditya Yoga',icon:'‚òÄÔ∏è',
    desc:'Sun and Mercury conjunct. Enhances intelligence, communication, and fame.',
    check:(pd)=>pd.Sun&&pd.Mercury&&pd.Sun.sign===pd.Mercury.sign},
  {name:'Chandra-Mangal Yoga',icon:'üåô',
    desc:'Moon and Mars conjunct. Strong willpower, financial acumen, emotional courage.',
    check:(pd)=>pd.Moon&&pd.Mars&&pd.Moon.sign===pd.Mars.sign},
  {name:'Lakshmi Yoga',icon:'ü™∑',
    desc:'Venus in kendra/trikona in own sign or exaltation. Wealth and grace.',
    check:(pd,ls)=>checkPanchaMahapurusha(pd,ls,'Venus',[1,4,5,7,9,10])},
  {name:'Hamsa Yoga',icon:'üïäÔ∏è',
    desc:'Jupiter in own sign or exaltation in a kendra. Pure soul and dharmic path.',
    check:(pd,ls)=>checkPanchaMahapurusha(pd,ls,'Jupiter',[1,4,7,10])},
  {name:'Malavya Yoga',icon:'üíé',
    desc:'Venus in own sign or exaltation in a kendra. Luxury and artistic talent.',
    check:(pd,ls)=>checkPanchaMahapurusha(pd,ls,'Venus',[1,4,7,10])},
  {name:'Sasa Yoga',icon:'ü™ê',
    desc:'Saturn in own sign or exaltation in a kendra. Discipline and longevity.',
    check:(pd,ls)=>checkPanchaMahapurusha(pd,ls,'Saturn',[1,4,7,10])},
  {name:'Ruchaka Yoga',icon:'‚öîÔ∏è',
    desc:'Mars in own sign or exaltation in a kendra. Courage and physical authority.',
    check:(pd,ls)=>checkPanchaMahapurusha(pd,ls,'Mars',[1,4,7,10])},
  {name:'Kemadruma Yoga',icon:'‚ö†Ô∏è',
    desc:'Moon isolated ‚Äî no planets in 2nd or 12th from it. Challenges and hardship.',
    check:(pd)=>{
      if(!pd.Moon)return false;
      const mi=SIGNS.indexOf(pd.Moon.sign);
      const prev=SIGNS[(mi-1+12)%12],next=SIGNS[(mi+1)%12];
      return!['Sun','Mars','Mercury','Jupiter','Venus','Saturn'].some(p=>pd[p]&&
        (pd[p].sign===prev||pd[p].sign===next||pd[p].sign===pd.Moon.sign));
    }}
];

// Helper for Pancha Mahapurusha yogas
function checkPanchaMahapurusha(pd,ls,pid,houses){
  if(!ls||!pd[pid])return false;
  const h=houseOf(pd[pid].sign,ls);
  return houses.includes(h)&&(EXALT[pid]===pd[pid].sign||(PLANET_RULES[pid]||[]).includes(pd[pid].sign));
}

/* ‚îÄ‚îÄ Translations (only the strings that differ) ‚îÄ‚îÄ */
const TRANS = {
  en:{
    title:'South Indian Vedic Astrology Chart',subtitle:'Interactive ‚Ä¢ Drag planets into signs',
    bankTitle:'Planet Bank ‚Äî Drag into chart',
    bankTip:'Drag planets from here into a chart sign box. Double-tap a placed planet to return it here. Tap once to set retrograde & exact degree.',
    degHint:'Tap placed planet ‚Üí set exact degree & retrograde',
    hideSigns:'Hide Signs',showSigns:'Show Signs',hideNums:'Hide Numbers',showNums:'Show Numbers',
    clearChart:'Clear Chart',retroLabel:'Retrograde',close:'Close',
    nakshatra:'Nakshatra',pada:'Pada',houseKw:'House Keywords',signKw:'Sign Keywords',
    ruler:'Ruler',element:'Element',modality:'Modality',lordOf:'Lord of',houseLord:'House Lordship',
    noLagna:'(Place Lagna to see house info)',center1:'South Indian',center2:'Chart',
    exalted:'Exalted',debilitated:'Debil.',ownSign:'Own',
    pnames:{Lagna:'Lagna',Sun:'Sun',Moon:'Moon',Mars:'Mars',Mercury:'Mercury',Jupiter:'Jupiter',Venus:'Venus',Saturn:'Saturn',Rahu:'Rahu',Ketu:'Ketu'},
    psym:{Lagna:'L',Sun:'Su',Moon:'Mo',Mars:'Ma',Mercury:'Me',Jupiter:'Ju',Venus:'Ve',Saturn:'Sa',Rahu:'Ra',Ketu:'Ke'},
    snames:{Aries:'Aries',Taurus:'Taurus',Gemini:'Gemini',Cancer:'Cancer',Leo:'Leo',Virgo:'Virgo',Libra:'Libra',Scorpio:'Scorpio',Sagittarius:'Sagittarius',Capricorn:'Capricorn',Aquarius:'Aquarius',Pisces:'Pisces'},
    ssym:{Aries:'Ar',Taurus:'Ta',Gemini:'Ge',Cancer:'Cn',Leo:'Le',Virgo:'Vi',Libra:'Li',Scorpio:'Sc',Sagittarius:'Sg',Capricorn:'Cp',Aquarius:'Aq',Pisces:'Pi'},
    hn:['','1st House','2nd House','3rd House','4th House','5th House','6th House','7th House','8th House','9th House','10th House','11th House','12th House']
  },
  te:{
    title:'‡∞¶‡∞ï‡±ç‡∞∑‡∞ø‡∞£ ‡∞≠‡∞æ‡∞∞‡∞§‡±Ä‡∞Ø ‡∞µ‡±á‡∞¶ ‡∞ú‡±ç‡∞Ø‡±ã‡∞§‡∞ø‡∞∑‡±ç‡∞Ø ‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç',subtitle:'‡∞á‡∞Ç‡∞ü‡∞∞‡∞æ‡∞ï‡±ç‡∞ü‡∞ø‡∞µ‡±ç ‚Ä¢ ‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞≤‡∞®‡±Å ‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞≤‡±ã ‡∞â‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø',
    bankTitle:'‡∞ó‡±ç‡∞∞‡∞π ‡∞¨‡±ç‡∞Ø‡∞æ‡∞Ç‡∞ï‡±ç ‚Äî ‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç‚Äå‡∞≤‡±ã‡∞ï‡∞ø ‡∞≤‡∞æ‡∞ó‡∞Ç‡∞°‡∞ø',
    bankTip:'‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞∞‡∞æ‡∞∂‡∞ø‡∞≤‡±ã‡∞ï‡∞ø ‡∞≤‡∞æ‡∞ó‡∞Ç‡∞°‡∞ø. ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø ‡∞°‡∞ø‡∞ó‡±ç‡∞∞‡±Ä/‡∞µ‡∞ï‡±ç‡∞∞‡∞ø ‡∞∏‡±Ü‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø. ‡∞∞‡±Ü‡∞Ç‡∞°‡±Å‡∞∏‡∞æ‡∞∞‡±ç‡∞≤‡±Å ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞§‡∞ø‡∞∞‡∞ø‡∞ó‡∞ø ‡∞™‡∞Ç‡∞™‡∞Ç‡∞°‡∞ø.',
    degHint:'‡∞ó‡±ç‡∞∞‡∞π‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞°‡∞ø‡∞ó‡±ç‡∞∞‡±Ä & ‡∞µ‡∞ï‡±ç‡∞∞‡∞ø ‡∞∏‡±Ü‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',
    hideSigns:'‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞®‡±Å ‡∞¶‡∞æ‡∞ö‡±Å',showSigns:'‡∞∞‡∞æ‡∞∂‡±Å‡∞≤‡∞®‡±Å ‡∞ö‡±Ç‡∞™‡±Å',hideNums:'‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‡∞≤‡∞®‡±Å ‡∞¶‡∞æ‡∞ö‡±Å',showNums:'‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‡∞≤‡∞®‡±Å ‡∞ö‡±Ç‡∞™‡±Å',
    clearChart:'‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞ï‡±ç‡∞≤‡∞ø‡∞Ø‡∞∞‡±ç',retroLabel:'‡∞µ‡∞ï‡±ç‡∞∞‡∞ø',close:'‡∞Æ‡±Ç‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞ø',
    nakshatra:'‡∞®‡∞ï‡±ç‡∞∑‡∞§‡±ç‡∞∞‡∞Ç',pada:'‡∞™‡∞æ‡∞¶',houseKw:'‡∞á‡∞Ç‡∞ü‡∞ø ‡∞ï‡±Ä‡∞µ‡∞∞‡±ç‡∞°‡±ç‡∞∏‡±ç',signKw:'‡∞∞‡∞æ‡∞∂‡∞ø ‡∞ï‡±Ä‡∞µ‡∞∞‡±ç‡∞°‡±ç‡∞∏‡±ç',
    ruler:'‡∞™‡∞æ‡∞≤‡∞ï ‡∞ó‡±ç‡∞∞‡∞π‡∞Ç',element:'‡∞Æ‡±Ç‡∞≤‡∞ï‡∞Ç',modality:'‡∞Æ‡±ã‡∞°‡∞æ‡∞≤‡∞ø‡∞ü‡±Ä',lordOf:'‡∞Ö‡∞ß‡∞ø‡∞™‡∞§‡∞ø',houseLord:'‡∞á‡∞Ç‡∞ü‡∞ø ‡∞Ü‡∞ß‡∞ø‡∞™‡∞§‡±ç‡∞Ø‡∞Ç',
    noLagna:'(‡∞á‡∞Ç‡∞ü‡∞ø ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç ‡∞ö‡±Ç‡∞°‡∞ü‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞≤‡∞ó‡±ç‡∞®‡∞æ‡∞®‡∞ø ‡∞â‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø)',center1:'‡∞¶‡∞ï‡±ç‡∞∑‡∞ø‡∞£ ‡∞≠‡∞æ‡∞∞‡∞§‡±Ä‡∞Ø',center2:'‡∞ö‡∞æ‡∞∞‡±ç‡∞ü‡±ç',
    exalted:'‡∞â‡∞ö‡±ç‡∞ö',debilitated:'‡∞®‡±Ä‡∞ö',ownSign:'‡∞∏‡±ç‡∞µ',
    pnames:{Lagna:'‡∞≤‡∞ó‡±ç‡∞®',Sun:'‡∞∏‡±Ç‡∞∞‡±ç‡∞Ø‡±Å‡∞°‡±Å',Moon:'‡∞ö‡∞Ç‡∞¶‡±ç‡∞∞‡±Å‡∞°‡±Å',Mars:'‡∞ï‡±Å‡∞ú‡±Å‡∞°‡±Å',Mercury:'‡∞¨‡±Å‡∞ß‡±Å‡∞°‡±Å',Jupiter:'‡∞ó‡±Å‡∞∞‡±Å‡∞°‡±Å',Venus:'‡∞∂‡±Å‡∞ï‡±ç‡∞∞‡±Å‡∞°‡±Å',Saturn:'‡∞∂‡∞®‡∞ø',Rahu:'‡∞∞‡∞æ‡∞π‡±Å‡∞µ‡±Å',Ketu:'‡∞ï‡±á‡∞§‡±Å‡∞µ‡±Å'},
    psym:{Lagna:'‡∞≤',Sun:'‡∞∏‡±Ç',Moon:'‡∞ö‡∞Ç',Mars:'‡∞ï‡±Å',Mercury:'‡∞¨‡±Å',Jupiter:'‡∞ó‡±Å',Venus:'‡∞∂‡±Å',Saturn:'‡∞∂',Rahu:'‡∞∞‡∞æ',Ketu:'‡∞ï‡±á'},
    snames:{Aries:'‡∞Æ‡±á‡∞∑‡∞Ç',Taurus:'‡∞µ‡±É‡∞∑‡∞≠‡∞Ç',Gemini:'‡∞Æ‡∞ø‡∞•‡±Å‡∞®‡∞Ç',Cancer:'‡∞ï‡∞∞‡±ç‡∞ï‡∞æ‡∞ü‡∞ï‡∞Ç',Leo:'‡∞∏‡∞ø‡∞Ç‡∞π‡∞Ç',Virgo:'‡∞ï‡∞®‡±ç‡∞Ø',Libra:'‡∞§‡±Å‡∞≤',Scorpio:'‡∞µ‡±É‡∞∂‡±ç‡∞ö‡∞ø‡∞ï‡∞Ç',Sagittarius:'‡∞ß‡∞®‡±Å‡∞∏‡±ç‡∞∏‡±Å',Capricorn:'‡∞Æ‡∞ï‡∞∞‡∞Ç',Aquarius:'‡∞ï‡±Å‡∞Ç‡∞≠‡∞Ç',Pisces:'‡∞Æ‡±Ä‡∞®‡∞Ç'},
    ssym:{Aries:'‡∞Æ‡±á',Taurus:'‡∞µ‡±É',Gemini:'‡∞Æ‡∞ø',Cancer:'‡∞ï',Leo:'‡∞∏‡∞ø‡∞Ç',Virgo:'‡∞ï‡∞®‡±ç‡∞Ø',Libra:'‡∞§‡±Å',Scorpio:'‡∞µ‡±É‡∞∂‡±ç‡∞ö‡∞ø',Sagittarius:'‡∞ß‡∞®‡±Å',Capricorn:'‡∞Æ‡∞ï',Aquarius:'‡∞ï‡±Å‡∞Ç',Pisces:'‡∞Æ‡±Ä'},
    hn:['','1‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','2‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','3‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','4‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','5‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','6‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','7‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','8‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','9‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','10‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','11‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å','12‡∞µ ‡∞á‡∞≤‡±ç‡∞≤‡±Å']
  }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE  (single object)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const S = {
  lang:'en',
  lagnaSign:null,
  signsHidden:false,
  numsHidden:false,
  planetData:{},            // { pid: {sign, degree, retro} }
  activePid:null,           // pid being edited in retroPanel
  drag:null,                // drag state object
  lastDragEnd:0,
  lastTap:{pid:null,time:0}
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOM SHORTCUTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $  = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const $q = sel => document.querySelector(sel);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const T = () => TRANS[S.lang];

// 1-based house number of a sign relative to lagna
function houseOf(sign, lagna = S.lagnaSign) {
  if (!lagna) return null;
  return (SIGNS.indexOf(sign) - SIGNS.indexOf(lagna) + 12) % 12 + 1;
}

function getNakshatra(sign, deg) {
  const total = SIGNS.indexOf(sign) * 30 + deg;
  const span  = 360 / 27;
  const ni    = Math.min(26, Math.floor(total / span));
  const pada  = Math.min(4, Math.floor((total % span) / (span / 4)) + 1);
  const [name, lord, kw] = NAKSH[ni];
  return {name, lord, kw, pada};
}

function getStrength(pid, sign) {
  if (!pid || pid === 'Lagna') return null;
  if (EXALT[pid]  === sign) return 'exalted';
  if (DEBIL[pid]  === sign) return 'debilitated';
  if ((PLANET_RULES[pid]||[]).includes(sign)) return 'own';
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHART GRID ‚Äî GENERATE CELLS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildGrid() {
  const grid = $('chartGrid');
  grid.innerHTML = '';

  // The center spans grid-area:center ‚Äî insert it at the right DOM position
  // South Indian layout order in DOM: Pisces Aries Taurus Gemini Aquarius [center] Cancer Capricorn Leo Sagittarius Scorpio Libra Virgo
  const ORDER = ['Pisces','Aries','Taurus','Gemini','Aquarius','__CENTER__','Cancer','Capricorn','Leo','Sagittarius','Scorpio','Libra','Virgo'];

  ORDER.forEach(sign => {
    if (sign === '__CENTER__') {
      const c = document.createElement('div');
      c.className = 'cell-center';
      c.id = 'centerCell';
      c.innerHTML = `<span class="center-line" id="centerLine1">${T().center1}</span>
                     <span class="center-line" id="centerLine2">${T().center2}</span>
                     <div id="yogaBadgeArea"></div>`;
      grid.appendChild(c);
      return;
    }
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.sign = sign;
    cell.innerHTML = `<span class="sign-abbr" data-sign="${sign}"></span>
                      <span class="house-num"></span>
                      <div class="planets-area" data-sign="${sign}"></div>`;
    grid.appendChild(cell);
  });

  // Attach sign-abbr click listeners
  $$('.sign-abbr').forEach(el => {
    el.addEventListener('click', ev => {
      ev.stopPropagation();
      if (!S.signsHidden) showSignPanel(el.dataset.sign, ev.clientX, ev.clientY);
    });
    el.addEventListener('mouseenter', ev => {
      if (!S.signsHidden) showSignPanel(el.dataset.sign, ev.clientX, ev.clientY);
    });
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLANET ELEMENTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildPlanet(pid) {
  const el = document.createElement('span');
  el.className = `planet ${pid}`;
  el.dataset.pid = pid;
  refreshChip(el);
  return el;
}

function refreshChip(el) {
  const pid = el.dataset.pid;
  const t   = T();
  const sym = t.psym[pid] || pid.slice(0,2);
  const d   = S.planetData[pid];
  let html  = sym;
  if (d) {
    html += `<span class="deg-label">${d.degree.toFixed(1)}¬∞</span>`;
    if (d.retro) html += `<span class="retro-mark">R</span>`;
  }
  el.innerHTML = html;
}

function refreshAllChips() {
  $$('.planet').forEach(refreshChip);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PLANET BANK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rebuildBank() {
  const bank    = $('planetBank');
  const inChart = new Set([...$$(`.planets-area .planet`)].map(el => el.dataset.pid));
  bank.querySelectorAll('.planet').forEach(el => el.remove());
  ALL_PIDS.forEach(pid => {
    if (!inChart.has(pid)) bank.appendChild(buildPlanet(pid));
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HOUSE NUMBERS & SIGN LABELS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateHouseNums() {
  $$('.cell[data-sign]').forEach(cell => {
    const h  = houseOf(cell.dataset.sign);
    cell.querySelector('.house-num').textContent = (h && !S.numsHidden) ? h : '';
  });
}

function updateSignLabels() {
  const t = T();
  $$('.sign-abbr').forEach(el => {
    el.textContent = t.ssym[el.dataset.sign] || el.dataset.sign.slice(0,2);
    el.classList.toggle('hidden-label', S.signsHidden);
  });
  $$('.house-num').forEach(el => el.classList.toggle('hidden-label', S.numsHidden));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOVE / RETURN PLANETS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function movePlanet(pid, targetSign) {
  $q(`.planet[data-pid="${pid}"]`)?.remove();
  if (pid === 'Lagna') S.lagnaSign = targetSign;
  const d = S.planetData[pid];
  if (!d) S.planetData[pid] = {sign:targetSign, degree:+(Math.random()*30).toFixed(2), retro:false};
  else    d.sign = targetSign;
  const area = $q(`.planets-area[data-sign="${targetSign}"]`);
  if (area) area.appendChild(buildPlanet(pid));
  updateHouseNums();
  detectYogas();
  updateAspects();
}

function returnToBank(pid) {
  const el = $q(`.planets-area .planet[data-pid="${pid}"]`);
  if (!el) return;
  el.remove();
  delete S.planetData[pid];
  if (pid === 'Lagna') { S.lagnaSign = null; updateHouseNums(); }
  const bank  = $('planetBank');
  const after = ALL_PIDS.slice(ALL_PIDS.indexOf(pid) + 1)
    .map(id => bank.querySelector(`.planet[data-pid="${id}"]`)).find(Boolean);
  const chip  = buildPlanet(pid);
  after ? bank.insertBefore(chip, after) : bank.appendChild(chip);
  detectYogas();
  updateAspects();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   YOGA DETECTION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function detectYogas() {
  const panel    = $('yogasPanel');
  const detected = YOGA_DEFS.filter(y => y.check(S.planetData, S.lagnaSign));
  panel.innerHTML = '';

  if (!detected.length) {
    panel.innerHTML = '<div class="yoga-empty">No yogas detected yet. Place more planets in the chart.</div>';
    $('yogaBadgeArea').innerHTML = '';
    return;
  }

  detected.forEach(y => {
    const card = document.createElement('div');
    card.className = 'yoga-card';
    card.innerHTML = `<div class="yoga-icon">${y.icon}</div>
      <div><div class="yoga-name">${y.name}</div><div class="yoga-desc">${y.desc}</div></div>`;
    panel.appendChild(card);
  });

  $('yogaBadgeArea').innerHTML =
    `<div class="yoga-badge detected">${detected.length} Yoga${detected.length>1?'s':''}</div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ASPECTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateAspects() {
  const panel  = $('aspectsPanel');
  const placed = ALL_PIDS.filter(p => p !== 'Lagna' && S.planetData[p]);
  if (!S.lagnaSign || placed.length < 2) {
    panel.innerHTML = '<div class="yoga-empty">Place Lagna and planets to see special aspects (drishti)</div>';
    return;
  }
  const t = T();
  let html = `<div style="font-family:'Cinzel',serif;font-size:.7rem;color:var(--text-muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px">Special Aspects (Drishti)</div>`;
  let found = false;

  placed.forEach(pid => {
    if (!SPECIAL_ASPECTS[pid]) return;
    const fromH = houseOf(S.planetData[pid].sign);
    if (!fromH) return;
    const aspH = SPECIAL_ASPECTS[pid].map(off => ((fromH - 1 + off - 1) % 12) + 1);

    const aspSigns   = SIGNS.filter(s => { const h=houseOf(s); return h&&aspH.includes(h); });
    const aspPlanets = placed.filter(p2 => p2!==pid && aspSigns.includes(S.planetData[p2]?.sign));

    if (!aspPlanets.length && aspSigns.length) {
      html += `<div class="aspect-entry">
        <span style="color:var(--text-muted);font-family:'Cinzel',serif;font-size:.7rem">${t.pnames[pid]}</span>
        <span style="color:var(--text-muted)">aspects Houses ${aspH.join(', ')} (empty)</span>
      </div>`;
      found = true;
      return;
    }
    aspPlanets.forEach(p2 => {
      const toH = houseOf(S.planetData[p2].sign);
      html += `<div class="aspect-entry">
        <span class="planet ${pid}" style="pointer-events:none;transform:none;box-shadow:none;font-size:.62rem;padding:2px 6px">${t.psym[pid]}</span>
        <span style="color:var(--accent);font-size:.85rem">‚Üí</span>
        <span class="planet ${p2}" style="pointer-events:none;transform:none;box-shadow:none;font-size:.62rem;padding:2px 6px">${t.psym[p2]}</span>
        <span style="color:var(--text-dim);font-size:.76rem">${t.pnames[pid]} ‚Üí ${t.pnames[p2]} in H${toH}</span>
      </div>`;
      found = true;
    });
  });

  if (!found) html += '<div class="yoga-empty">No special aspects found between placed planets.</div>';
  panel.innerHTML = html;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AI PROMPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function generatePrompt() {
  const t      = T();
  const placed = ALL_PIDS.filter(p => S.planetData[p]);
  if (!placed.length) { $('promptOutput').textContent = ''; return; }

  const lagnaInfo = S.planetData.Lagna;
  const lagnaText = lagnaInfo
    ? `Lagna (Ascendant): ${lagnaInfo.sign} (${lagnaInfo.degree.toFixed(2)}¬∞)`
    : 'Lagna: Not placed';

  const lines = ALL_PIDS.filter(p => p!=='Lagna' && S.planetData[p]).map(pid => {
    const d   = S.planetData[pid];
    const nak = getNakshatra(d.sign, d.degree);
    const hn  = S.lagnaSign ? houseOf(d.sign) : null;
    const str = getStrength(pid, d.sign);
    let ln = `${t.pnames[pid]}: ${d.sign} at ${d.degree.toFixed(2)}¬∞ ‚Äî ${nak.name} (Pada ${nak.pada}, Lord: ${nak.lord})`;
    if (hn)  ln += `, ${t.hn[hn]}`;
    if (str) ln += ` [${str==='exalted'?'EXALTED':str==='debilitated'?'DEBILITATED':'Own Sign'}]`;
    if (d.retro) ln += ' ‚Ñû (Retrograde)';
    return ln;
  });

  const yogas = YOGA_DEFS.filter(y => y.check(S.planetData, S.lagnaSign)).map(y => y.name);

  $('promptOutput').textContent =
`I have a South Indian Vedic (Jyotisha) natal chart with the following planetary positions. Please analyze this chart using classical Vedic astrology principles (Parashari system).

‚ïê‚ïê‚ïê CHART DETAILS ‚ïê‚ïê‚ïê
${lagnaText}

${lines.join('\n')}
${yogas.length ? '\nDetected Yogas: '+yogas.join(', ') : ''}

‚ïê‚ïê‚ïê READING REQUEST ‚ïê‚ïê‚ïê
Please provide a comprehensive Vedic astrology reading covering all major life areas: personality, health, career, finances, relationships, family, spirituality, and life purpose. Discuss the strength and effects of each planet, any special yogas or combinations, and major themes of this chart.

Please use traditional Vedic astrology methods (not Western/Tropical). Consider planetary dignities, house lordships, conjunctions, and special aspects in your analysis.`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FLOATING PANEL HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function positionPanel(el, x, y) {
  const w=el.offsetWidth||200, h=el.offsetHeight||100;
  const vw=window.innerWidth, vh=window.innerHeight;
  let lx = x+14, ly = y-h-10;
  if (lx+w > vw-8) lx = x-w-14;
  if (lx < 8)       lx = 8;
  if (ly < 8)        ly = y+24;
  if (ly+h > vh-8)   ly = vh-h-8;
  el.style.left = lx+'px';
  el.style.top  = ly+'px';
}

function hideAllPanels() {
  $('tooltip').classList.remove('visible');
  $('retroPanel').classList.remove('visible');
  $('signPanel').classList.remove('visible');
  $('overlay').classList.remove('visible');
  S.activePid = null;
}

/* ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ */
function showTooltip(pid, x, y) {
  const t   = T();
  const d   = S.planetData[pid];
  if (!d) return;
  const nak = getNakshatra(d.sign, d.degree);
  const str = getStrength(pid, d.sign);
  const sc  = {exalted:'var(--green)',debilitated:'var(--red)',own:'var(--gold)'};
  const sl  = {exalted:t.exalted,debilitated:t.debilitated,own:t.ownSign};
  let html  = `<strong>${t.pnames[pid]}</strong>
    <div class="trow">${d.degree.toFixed(2)}¬∞ ${t.snames[d.sign]||d.sign}</div>
    <div class="trow"><span>${t.nakshatra}:</span> ${nak.name} (Lord: ${nak.lord})</div>
    <div class="trow"><span>Keywords:</span> ${nak.kw}</div>
    <div class="trow"><span>${t.pada}:</span> ${nak.pada}</div>`;
  if (str) html += `<div class="trow" style="color:${sc[str]}">‚¨• ${sl[str]}</div>`;
  if (d.retro) html += `<div class="trow" style="color:var(--red)">(${t.retroLabel})</div>`;
  if (S.lagnaSign && PLANET_RULES[pid]) {
    html += `<hr><div style="color:var(--gold);font-family:'Cinzel',serif;font-size:.7rem;margin-bottom:2px">${t.houseLord}</div>`;
    PLANET_RULES[pid].forEach(rs => {
      const h = houseOf(rs);
      html += `<div class="trow">${t.lordOf} ${t.hn[h]||'H'+h}: <span>${(HOUSE_KW[h]||'').split(',').slice(0,2).join(',')}</span></div>`;
    });
  }
  const tip = $('tooltip');
  tip.innerHTML = html;
  tip.classList.add('visible');
  positionPanel(tip, x, y);
}

/* ‚îÄ‚îÄ Retro Panel ‚îÄ‚îÄ */
function showRetroPanel(pid, x, y) {
  hideAllPanels();
  S.activePid = pid;
  const t = T();
  $('retroTitle').textContent  = t.pnames[pid] || pid;
  $('retroCheck').checked      = !!S.planetData[pid]?.retro;
  $('degInput').value          = S.planetData[pid]?.degree?.toFixed(2) ?? '0';
  $('retroLabel').textContent  = t.retroLabel;
  const panel = $('retroPanel');
  panel.classList.add('visible');
  $('overlay').classList.add('visible');
  positionPanel(panel, x, y);
}

/* ‚îÄ‚îÄ Sign Panel ‚îÄ‚îÄ */
function showSignPanel(sign, x, y) {
  hideAllPanels();
  const t  = T();
  const sd = SIGN_DATA[sign];   // [kw, ruler, el, mod, symbol]
  const h  = houseOf(sign);
  $('spSignName').textContent = `${sd?.[4]||''} ${t.snames[sign]||sign}`;
  let body = '';
  if (h) {
    body += `<div><strong>House:</strong> ${t.hn[h]}</div>`;
    body += `<div><strong>${t.houseKw}:</strong> ${HOUSE_KW[h]}</div><hr>`;
  } else {
    body += `<div style="color:var(--text-muted);font-style:italic">${t.noLagna}</div><hr>`;
  }
  if (sd) {
    body += `<div><strong>${t.signKw}:</strong> ${sd[0]}</div>`;
    body += `<div><strong>${t.ruler}:</strong> ${sd[1]} &nbsp;|&nbsp; <strong>${t.element}:</strong> ${sd[2]} &nbsp;|&nbsp; <strong>${t.modality}:</strong> ${sd[3]}</div>`;
  }
  $('spBody').innerHTML = body;
  const panel = $('signPanel');
  panel.classList.add('visible');
  $('overlay').classList.add('visible');
  positionPanel(panel, x, y);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LANGUAGE UPDATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function applyLang() {
  const t = T();
  $('appTitle').textContent    = t.title;
  $('appSubtitle').textContent = t.subtitle;
  $('bankTitle').textContent   = t.bankTitle;
  $('bankTip').textContent     = t.bankTip;
  $('degHint').textContent     = t.degHint;
  $('centerLine1').textContent = t.center1;
  $('centerLine2').textContent = t.center2;
  $('retroLabel').textContent  = t.retroLabel;
  $('retroClose').textContent  = t.close;
  $('spClose').textContent     = t.close;
  $('btnSigns').textContent    = S.signsHidden ? t.showSigns : t.hideSigns;
  $('btnNums').textContent     = S.numsHidden  ? t.showNums  : t.hideNums;
  $('btnClear').textContent    = t.clearChart;
  updateSignLabels();
  updateHouseNums();
  refreshAllChips();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAG & DROP  (Pointer Events)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ghost = $('drag-ghost');

document.addEventListener('pointerdown',  onPD, {passive:false});
document.addEventListener('pointermove',  onPM, {passive:false});
document.addEventListener('pointerup',    onPU, {passive:false});
document.addEventListener('pointercancel', () => { cleanDrag(); S.drag = null; });

function onPD(e) {
  if (S.drag) return;
  const el = e.target.closest('.planet');
  if (!el) return;
  e.preventDefault();
  const inChart = !!el.closest('.planets-area');
  const inBank  = !!el.closest('#planetBank');
  if (!inChart && !inBank) return;
  S.drag = {
    pid: el.dataset.pid, pointerId: e.pointerId, sourceEl: el,
    startX: e.clientX, startY: e.clientY,
    moved: false, isDegMode: false, dirLocked: false,
    initDeg: 0, inChart, ghostShown: false
  };
}

function onPM(e) {
  const dr = S.drag;
  if (!dr || e.pointerId !== dr.pointerId) return;
  e.preventDefault();
  const dx = e.clientX - dr.startX, dy = e.clientY - dr.startY;
  if (Math.hypot(dx, dy) < 5) return;
  dr.moved = true;

  if (dr.inChart && !dr.dirLocked) {
    dr.isDegMode = Math.abs(dy) > Math.abs(dx);
    dr.dirLocked = true;
    dr.initDeg   = S.planetData[dr.pid]?.degree ?? 0;
  }

  if (dr.isDegMode) {
    const deg = Math.max(0, Math.min(29.99, +(dr.initDeg + (dr.startY - e.clientY) / 22).toFixed(2)));
    if (S.planetData[dr.pid]) {
      S.planetData[dr.pid].degree = deg;
      refreshChip(dr.sourceEl);
      showTooltip(dr.pid, e.clientX, e.clientY);
    }
    return;
  }

  if (!dr.ghostShown) {
    dr.ghostShown = true;
    dr.sourceEl.classList.add('dragging');
    dr.sourceEl.style.pointerEvents = 'none';
    hideAllPanels();
    const clone = dr.sourceEl.cloneNode(true);
    clone.style.cssText = 'transform:none;pointer-events:none';
    ghost.innerHTML = '';
    ghost.appendChild(clone);
    ghost.style.display = 'block';
  }

  const w = ghost.offsetWidth||50, h = ghost.offsetHeight||26;
  ghost.style.left = (e.clientX - w/2)+'px';
  ghost.style.top  = (e.clientY - h/2)+'px';

  $$('.cell.drop-active,.planet-bank.drop-active').forEach(el => el.classList.remove('drop-active'));
  getDropTarget(e.clientX, e.clientY)?.classList.add('drop-active');
}

function onPU(e) {
  const dr = S.drag;
  if (!dr || e.pointerId !== dr.pointerId) return;
  e.preventDefault();
  cleanDrag();

  if (!dr.moved) {
    if (dr.inChart && S.planetData[dr.pid]) showRetroPanel(dr.pid, e.clientX, e.clientY);
    S.drag = null;
    return;
  }
  if (dr.isDegMode) { S.drag = null; return; }

  S.lastDragEnd = Date.now();
  const target = getDropTarget(e.clientX, e.clientY);
  if (target) {
    target.id === 'planetBank'
      ? returnToBank(dr.pid)
      : movePlanet(dr.pid, target.dataset.sign);
  }
  S.drag = null;
}

function cleanDrag() {
  ghost.style.display = 'none';
  ghost.innerHTML = '';
  $$('.cell.drop-active,.planet-bank.drop-active').forEach(el => el.classList.remove('drop-active'));
  if (S.drag?.sourceEl) {
    S.drag.sourceEl.classList.remove('dragging');
    S.drag.sourceEl.style.pointerEvents = '';
  }
  $('tooltip').classList.remove('visible');
}

function getDropTarget(x, y) {
  for (const el of document.elementsFromPoint(x, y)) {
    const cell = el.closest('.cell[data-sign]');
    if (cell) return cell;
    if (el.id === 'planetBank' || el.closest('#planetBank')) return $('planetBank');
  }
  return null;
}

/* ‚îÄ‚îÄ Double-tap to return ‚îÄ‚îÄ */
document.addEventListener('click', e => {
  if (Date.now() - S.lastDragEnd < 300) return;
  const el = e.target.closest('.planet');
  if (!el?.closest('.planets-area')) return;
  const pid = el.dataset.pid, now = Date.now();
  if (S.lastTap.pid === pid && now - S.lastTap.time < 400) {
    returnToBank(pid);
    hideAllPanels();
    S.lastTap = {pid:null, time:0};
  } else {
    S.lastTap = {pid, time:now};
  }
});

/* ‚îÄ‚îÄ Desktop hover ‚îÄ‚îÄ */
document.addEventListener('mousemove', e => {
  if (S.drag) return;
  const el = e.target.closest('.planet');
  el?.closest('.planets-area') && S.planetData[el.dataset.pid]
    ? showTooltip(el.dataset.pid, e.clientX, e.clientY)
    : !e.target.closest('#tooltip') && $('tooltip').classList.remove('visible');
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EVENT WIRING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Tabs
$$('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    $$('.tab-btn').forEach(b => b.classList.remove('active'));
    $$('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.dataset.tab;
    $(`tab-${id}`).classList.add('active');
    if (id === 'aspects') updateAspects();
    if (id === 'prompt')  generatePrompt();
  });
});

// Retro panel inputs
$('retroCheck').addEventListener('change', () => {
  const pid = S.activePid;
  if (!pid || !S.planetData[pid]) return;
  S.planetData[pid].retro = $('retroCheck').checked;
  refreshChip($q(`.planets-area .planet[data-pid="${pid}"]`));
  detectYogas();
});
$('degInput').addEventListener('input', () => {
  const pid = S.activePid;
  if (!pid || !S.planetData[pid]) return;
  const v = Math.max(0, Math.min(29.99, parseFloat($('degInput').value)||0));
  S.planetData[pid].degree = v;
  refreshChip($q(`.planets-area .planet[data-pid="${pid}"]`));
  detectYogas();
});

// Close buttons & overlay
['retroClose','spClose'].forEach(id => $$(   `#${id}`)[0]?.addEventListener('click', hideAllPanels));
$('retroClose').addEventListener('click', hideAllPanels);
$('spClose').addEventListener('click', hideAllPanels);
$('overlay').addEventListener('click', hideAllPanels);

// Outside-tap close
document.addEventListener('pointerdown', e => {
  if (!$('retroPanel').classList.contains('visible') && !$('signPanel').classList.contains('visible')) return;
  if (!e.target.closest('#retroPanel') && !e.target.closest('#signPanel') && !e.target.closest('.sign-abbr'))
    hideAllPanels();
}, {capture:true});

// Toolbar buttons
$('btnSigns').addEventListener('click', () => {
  S.signsHidden = !S.signsHidden;
  $('btnSigns').textContent = S.signsHidden ? T().showSigns : T().hideSigns;
  updateSignLabels();
});
$('btnNums').addEventListener('click', () => {
  S.numsHidden = !S.numsHidden;
  $('btnNums').textContent = S.numsHidden ? T().showNums : T().hideNums;
  updateHouseNums();
  updateSignLabels();
});
$('btnClear').addEventListener('click', () => {
  $$('.planets-area .planet').forEach(el => el.remove());
  S.planetData  = {};
  S.lagnaSign   = null;
  S.signsHidden = false;
  S.numsHidden  = false;
  S.drag        = null;
  ghost.style.display = 'none';
  rebuildBank();
  applyLang();
  detectYogas();
  updateAspects();
  $('promptOutput').textContent = '';
  hideAllPanels();
});

// Generate & copy prompt
$('btnGenPrompt').addEventListener('click', generatePrompt);
$('btnCopyPrompt').addEventListener('click', () => {
  const text = $('promptOutput').textContent;
  if (!text) return;
  const show = () => {
    const t = $('copyToast');
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
  };
  navigator.clipboard?.writeText(text).then(show).catch(() => {
    const ta = Object.assign(document.createElement('textarea'), {value:text});
    ta.style.cssText = 'position:fixed;opacity:0';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    show();
  });
});

// Language switch
$('lang').addEventListener('change', e => {
  S.lang = e.target.value;
  applyLang();
  hideAllPanels();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
buildGrid();
rebuildBank();
applyLang();
detectYogas();
updateAspects();
</script>
</body>
</html>
