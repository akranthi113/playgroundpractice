<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#f5f0e8">
<title>Vedic Astrology â€” South Indian Chart</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:           #f5f0e8;
  --surface:      #ffffff;
  --card:         #fdfaf5;
  --card2:        #f0ebe0;
  --border:       #d8ccb4;
  --border-hi:    #b8a888;
  --gold:         #8b6914;
  --gold-dim:     #c4a44a;
  --accent:       #4a6fa5;
  --accent-light: #6389bf;
  --text:         #2c2416;
  --text-dim:     #6b5b3e;
  --text-muted:   #a8956e;
  --red:          #c0392b;
  --green:        #27ae60;
  /* planet colours */
  --sun:     #e8930e;
  --moon:    #6e7d85;
  --mars:    #c0392b;
  --mercury: #219a52;
  --jupiter: #d4720e;
  --venus:   #c4177a;
  --saturn:  #4a5bb0;
  --rahu:    #4e6a76;
  --ketu:    #6d4c3e;
  --shadow:  0 2px 20px rgba(139,105,20,0.13);
}

/* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* â”€â”€ Body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body {
  background: var(--bg);
  background-image:
    radial-gradient(ellipse at 20% 0%, rgba(139,105,20,0.07) 0%, transparent 55%),
    radial-gradient(ellipse at 80% 100%, rgba(74,111,165,0.05) 0%, transparent 45%);
  color: var(--text);
  font-family: 'Crimson Pro', Georgia, serif;
  min-height: 100dvh;
  padding: clamp(12px, 3vw, 28px) clamp(12px, 4vw, 24px);
  display: flex;
  flex-direction: column;
  align-items: center;
  -webkit-tap-highlight-color: transparent;
  overflow-x: hidden;
}

/* â”€â”€ Layout shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-wrap {
  width: 100%;
  max-width: 640px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding-bottom: 4px;
}
.header-text { flex: 1; }
.app-title {
  font-family: 'Cinzel', serif;
  font-size: clamp(0.95rem, 3.8vw, 1.45rem);
  font-weight: 700;
  color: var(--gold);
  letter-spacing: 0.07em;
  line-height: 1.25;
}
.app-subtitle {
  font-size: clamp(0.72rem, 2vw, 0.82rem);
  color: var(--text-muted);
  margin-top: 3px;
  font-style: italic;
}
.lang-select {
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border-hi);
  border-radius: 7px;
  padding: 6px 10px;
  font-family: inherit;
  font-size: 0.82rem;
  cursor: pointer;
  outline: none;
  flex-shrink: 0;
}
.lang-select:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

/* â”€â”€ Chart wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-wrap {
  background: var(--surface);
  border: 2px solid var(--border-hi);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
  /* Keep it square-ish but never overflow viewport */
  width: 100%;
  aspect-ratio: 1 / 1;
  max-height: min(96vw, 560px);
}

/* â”€â”€ Chart Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(4, 1fr);
  gap: 1px;
  background: var(--border);
  width: 100%;
  height: 100%;
  grid-template-areas:
    "pisces    aries    taurus   gemini"
    "aquarius  center   center   cancer"
    "capricorn center   center   leo"
    "sagittarius scorpio libra  virgo";
}

/* â”€â”€ Sign cells â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cell {
  background: var(--card);
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 3px;
  overflow: hidden;
  transition: background 0.12s;
  min-width: 0;
}
.cell.drop-active {
  background: rgba(74,111,165,0.12);
  outline: 2px dashed var(--accent-light);
  outline-offset: -2px;
}
.cell[data-sign="Pisces"]       { grid-area: pisces; }
.cell[data-sign="Aries"]        { grid-area: aries; }
.cell[data-sign="Taurus"]       { grid-area: taurus; }
.cell[data-sign="Gemini"]       { grid-area: gemini; }
.cell[data-sign="Aquarius"]     { grid-area: aquarius; }
.cell[data-sign="Cancer"]       { grid-area: cancer; }
.cell[data-sign="Capricorn"]    { grid-area: capricorn; }
.cell[data-sign="Leo"]          { grid-area: leo; }
.cell[data-sign="Sagittarius"]  { grid-area: sagittarius; }
.cell[data-sign="Scorpio"]      { grid-area: scorpio; }
.cell[data-sign="Libra"]        { grid-area: libra; }
.cell[data-sign="Virgo"]        { grid-area: virgo; }

/* â”€â”€ Center cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cell-center {
  grid-area: center;
  background: var(--card2);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 5px;
}
.center-line {
  font-family: 'Cinzel', serif;
  font-size: clamp(0.44rem, 1.4vw, 0.65rem);
  color: var(--text-muted);
  letter-spacing: 0.13em;
  text-transform: uppercase;
  text-align: center;
}
.center-sym {
  font-size: clamp(1rem, 3.2vw, 1.6rem);
  opacity: 0.18;
  line-height: 1;
}

/* â”€â”€ Sign label (top-left of cell) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sign-abbr {
  position: absolute;
  top: 3px;
  left: 3px;
  font-family: 'Cinzel', serif;
  font-size: clamp(0.44rem, 1.3vw, 0.6rem);
  font-weight: 600;
  color: var(--text-muted);
  background: rgba(139,105,20,0.07);
  padding: 1px 3px;
  border-radius: 3px;
  letter-spacing: 0.03em;
  cursor: pointer;
  z-index: 2;
  user-select: none;
  transition: background 0.13s, color 0.13s;
  line-height: 1.35;
}
.sign-abbr:hover  { color: var(--gold); background: rgba(139,105,20,0.16); }
.sign-abbr:focus-visible { outline: 2px solid var(--gold); outline-offset: 1px; }
.sign-abbr.hidden { visibility: hidden; pointer-events: none; }

/* â”€â”€ House number (bottom-right of cell) â”€â”€â”€â”€â”€â”€â”€ */
.house-num {
  position: absolute;
  bottom: 3px;
  right: 4px;
  font-family: 'Cinzel', serif;
  font-size: clamp(0.44rem, 1.3vw, 0.6rem);
  color: var(--accent);
  font-weight: 700;
  opacity: 0.7;
  z-index: 2;
  line-height: 1;
}

/* â”€â”€ Planets area inside cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.planets-area {
  display: flex;
  flex-wrap: wrap;
  gap: 2px;
  justify-content: center;
  align-items: flex-start;
  align-content: flex-start;
  width: 100%;
  margin-top: 18px;
  padding: 1px;
  overflow: hidden;
  flex: 1;
}

/* â”€â”€ Planet chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.planet {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 1px;
  padding: clamp(2px, 0.5vw, 3px) clamp(3px, 1vw, 7px);
  border-radius: 5px;
  font-family: 'Cinzel', serif;
  font-size: clamp(0.5rem, 1.5vw, 0.68rem);
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  white-space: nowrap;
  transition: transform 0.1s, box-shadow 0.1s;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  touch-action: none;
  -webkit-touch-callout: none;
  min-width: clamp(22px, 6vw, 34px);
  z-index: 3;
  color: #fff;
  outline: none;
  border: none;
  position: relative;
}
.planet:hover        { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.25); }
.planet:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }
.planet.dragging     { opacity: 0.25; }

.planet.Lagna   { background: transparent; border: 2px solid var(--gold); color: var(--gold); }
.planet.Sun     { background: var(--sun); }
.planet.Moon    { background: var(--moon); }
.planet.Mars    { background: var(--mars); }
.planet.Mercury { background: var(--mercury); }
.planet.Jupiter { background: var(--jupiter); }
.planet.Venus   { background: var(--venus); }
.planet.Saturn  { background: var(--saturn); }
.planet.Rahu    { background: var(--rahu); }
.planet.Ketu    { background: var(--ketu); }

.deg-label {
  font-size: 0.55em;
  opacity: 0.88;
  font-family: 'Crimson Pro', serif;
  font-weight: 400;
}
.retro-mark {
  font-size: 0.6em;
  font-weight: 900;
  color: rgba(255,255,255,0.85);
  line-height: 1;
  margin-left: 1px;
}
.planet.Lagna .retro-mark { color: var(--red); }

/* â”€â”€ Drag ghost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#drag-ghost {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  opacity: 0.88;
  transform: scale(1.12);
  display: none;
}

/* â”€â”€ Panel (card wrapper) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.panel {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: clamp(12px, 3vw, 18px);
  box-shadow: var(--shadow);
}
.panel-title {
  font-family: 'Cinzel', serif;
  font-size: 0.68rem;
  font-weight: 600;
  color: var(--text-muted);
  letter-spacing: 0.13em;
  text-transform: uppercase;
  margin-bottom: 10px;
}

/* â”€â”€ Planet bank â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.planet-bank {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
  min-height: 44px;
  padding: 10px 8px;
  background: var(--card2);
  border: 1.5px dashed var(--border-hi);
  border-radius: 9px;
  margin-bottom: 12px;
  transition: background 0.13s, border-color 0.13s;
}
.planet-bank.drop-active {
  background: rgba(74,111,165,0.07);
  border-color: var(--accent-light);
}
/* Larger chips in the bank */
.planet-bank .planet {
  font-size: clamp(0.65rem, 2vw, 0.78rem);
  padding: clamp(5px, 1.2vw, 7px) clamp(9px, 2.5vw, 13px);
  min-width: clamp(36px, 9vw, 46px);
}

/* â”€â”€ Tip text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tip-box {
  font-size: clamp(0.72rem, 2vw, 0.8rem);
  color: var(--text-dim);
  background: rgba(139,105,20,0.045);
  border-left: 3px solid var(--gold-dim);
  padding: 7px 11px;
  border-radius: 0 7px 7px 0;
  line-height: 1.55;
  font-style: italic;
}

/* â”€â”€ Persist notice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.persist-notice {
  font-size: 0.72rem;
  color: var(--green);
  text-align: center;
  padding: 4px 0 0;
  font-style: italic;
  opacity: 0;
  transition: opacity 0.35s;
  min-height: 20px;
}
.persist-notice.show { opacity: 1; }

/* â”€â”€ Button row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 12px;
}
.btn {
  padding: clamp(6px, 1.5vw, 8px) clamp(12px, 3vw, 18px);
  font-family: 'Cinzel', serif;
  font-size: clamp(0.62rem, 1.8vw, 0.72rem);
  font-weight: 600;
  letter-spacing: 0.05em;
  border: 1px solid var(--border-hi);
  background: var(--surface);
  color: var(--text-dim);
  border-radius: 7px;
  cursor: pointer;
  transition: all 0.13s;
  text-transform: uppercase;
}
.btn:hover       { background: var(--card2); color: var(--text); border-color: var(--gold-dim); }
.btn:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }
.btn.danger      { border-color: rgba(192,57,43,0.3); color: var(--red); }
.btn.danger:hover { background: rgba(192,57,43,0.07); }

/* â”€â”€ AI Prompt panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prompt-output {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 9px;
  padding: 13px;
  font-size: clamp(0.72rem, 2vw, 0.8rem);
  line-height: 1.7;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 280px;
  overflow-y: auto;
  font-family: 'Crimson Pro', serif;
  -webkit-overflow-scrolling: touch;
}
.prompt-output:empty::before {
  content: 'Place Lagna and planets in the chart, then tap Generateâ€¦';
  color: var(--text-muted);
  font-style: italic;
}
.prompt-intro {
  font-size: clamp(0.72rem, 2vw, 0.8rem);
  color: var(--text-dim);
  line-height: 1.5;
  font-style: italic;
  margin-bottom: 10px;
}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.copy-toast {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(70px);
  background: rgba(39,174,96,0.96);
  color: #fff;
  font-family: 'Cinzel', serif;
  font-size: 0.75rem;
  letter-spacing: 0.07em;
  padding: 10px 22px;
  border-radius: 28px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.18);
  z-index: 9999;
  transition: transform 0.32s cubic-bezier(0.34,1.56,0.64,1), opacity 0.3s;
  opacity: 0;
  pointer-events: none;
  white-space: nowrap;
}
.copy-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* â”€â”€ Floating panels (tooltip / retro / sign) â”€â”€ */
.overlay {
  position: fixed;
  inset: 0;
  z-index: 4998;
  display: none;
}
.overlay.visible { display: block; }

.tooltip {
  position: fixed;
  background: rgba(255,252,245,0.98);
  border: 1px solid var(--border-hi);
  border-radius: 10px;
  padding: 11px 14px;
  font-size: clamp(0.72rem, 2vw, 0.8rem);
  line-height: 1.6;
  color: var(--text);
  z-index: 5100;
  pointer-events: none;
  max-width: min(280px, 88vw);
  box-shadow: 0 8px 28px rgba(139,105,20,0.18);
  backdrop-filter: blur(6px);
  display: none;
}
.tooltip.visible { display: block; }
.tooltip strong  { color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.76rem; }
.tooltip hr      { border: none; border-top: 1px solid var(--border); margin: 5px 0; }
.tooltip .trow   { display: block; margin-bottom: 2px; }
.tooltip .trow span { color: var(--text-muted); }
.t-strength      { font-weight: 600; font-size: 0.75rem; }

/* Retrograde + degree panel */
.retro-panel {
  position: fixed;
  background: rgba(255,252,245,0.99);
  border: 1px solid var(--gold-dim);
  border-radius: 12px;
  padding: 16px;
  z-index: 5200;
  box-shadow: 0 8px 32px rgba(139,105,20,0.22);
  display: none;
  flex-direction: column;
  gap: 12px;
  min-width: 195px;
  max-width: min(260px, 90vw);
}
.retro-panel.visible { display: flex; }
.retro-panel-title {
  font-family: 'Cinzel', serif;
  font-size: 0.8rem;
  color: var(--gold);
  font-weight: 700;
  border-bottom: 1px solid var(--border);
  padding-bottom: 8px;
}
.retro-panel label {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  font-size: 0.88rem;
  color: var(--text);
}
.retro-panel input[type=checkbox] {
  width: 18px; height: 18px;
  accent-color: var(--gold);
  cursor: pointer;
  flex-shrink: 0;
}
.deg-input-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.84rem;
  color: var(--text-dim);
}
.deg-input-row label { font-size: 0.84rem; }
.deg-input-row input[type=number] {
  width: 72px;
  background: var(--card2);
  border: 1px solid var(--border-hi);
  border-radius: 6px;
  color: var(--text);
  padding: 5px 9px;
  font-family: 'Crimson Pro', serif;
  font-size: 0.92rem;
  outline: none;
}
.deg-input-row input[type=number]:focus { border-color: var(--gold-dim); }
.panel-close {
  align-self: flex-end;
  font-size: 0.68rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 3px 10px;
  border: 1px solid var(--border);
  border-radius: 5px;
  font-family: 'Cinzel', serif;
  background: transparent;
  transition: color 0.12s;
}
.panel-close:hover        { color: var(--text); }
.panel-close:focus-visible { outline: 2px solid var(--gold); }

/* Sign info panel */
.sign-panel {
  position: fixed;
  background: rgba(255,252,245,0.99);
  border: 1px solid var(--border-hi);
  border-radius: 12px;
  padding: 13px 16px;
  z-index: 5200;
  box-shadow: 0 8px 28px rgba(139,105,20,0.15);
  display: none;
  flex-direction: column;
  gap: 5px;
  max-width: min(270px, 90vw);
  font-size: clamp(0.72rem, 2vw, 0.8rem);
  line-height: 1.55;
}
.sign-panel.visible { display: flex; }
.sign-panel strong  { color: var(--gold); font-family: 'Cinzel', serif; font-size: 0.76rem; }
.sign-panel hr      { border: none; border-top: 1px solid var(--border); margin: 3px 0; }

/* â”€â”€ Colour legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.legend {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 10px;
  padding: 10px 0 2px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: clamp(0.62rem, 1.8vw, 0.72rem);
  color: var(--text-dim);
}
.legend-dot {
  width: 10px; height: 10px;
  border-radius: 3px;
  flex-shrink: 0;
}

/* â”€â”€ Responsive tweaks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 380px) {
  .chart-grid { gap: 1px; }
  .planet-bank { gap: 5px; padding: 8px 6px; }
}
@media (min-width: 640px) {
  .chart-wrap { max-height: 560px; }
}
/* Safe area for notched phones */
@supports (padding: max(0px)) {
  body {
    padding-bottom: max(clamp(12px,3vw,28px), env(safe-area-inset-bottom));
    padding-left:  max(clamp(12px,4vw,24px), env(safe-area-inset-left));
    padding-right: max(clamp(12px,4vw,24px), env(safe-area-inset-right));
  }
}
</style>
</head>
<body>

<div id="drag-ghost" aria-hidden="true"></div>
<div class="overlay" id="overlay"></div>
<div class="copy-toast" id="copyToast" role="status" aria-live="polite"></div>

<div class="app-wrap">

  <!-- â”€â”€ Header â”€â”€ -->
  <header class="app-header">
    <div class="header-text">
      <div class="app-title" id="appTitle">South Indian Vedic Chart</div>
      <div class="app-subtitle" id="appSubtitle">Drag planets Â· tap to edit Â· double-tap to remove</div>
    </div>
    <select class="lang-select" id="lang" aria-label="Language">
      <option value="en">English</option>
      <option value="te">à°¤à±†à°²à±à°—à±</option>
    </select>
  </header>

  <!-- â”€â”€ Chart â”€â”€ -->
  <div class="chart-wrap" role="region" aria-label="South Indian Vedic chart">
    <div class="chart-grid" id="chartGrid">

      <div class="cell" data-sign="Pisces">
        <span class="sign-abbr" data-sign="Pisces" tabindex="0" role="button">Pi</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Pisces"></div>
      </div>
      <div class="cell" data-sign="Aries">
        <span class="sign-abbr" data-sign="Aries" tabindex="0" role="button">Ar</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Aries"></div>
      </div>
      <div class="cell" data-sign="Taurus">
        <span class="sign-abbr" data-sign="Taurus" tabindex="0" role="button">Ta</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Taurus"></div>
      </div>
      <div class="cell" data-sign="Gemini">
        <span class="sign-abbr" data-sign="Gemini" tabindex="0" role="button">Ge</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Gemini"></div>
      </div>

      <div class="cell" data-sign="Aquarius">
        <span class="sign-abbr" data-sign="Aquarius" tabindex="0" role="button">Aq</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Aquarius"></div>
      </div>
      <div class="cell-center" aria-hidden="true">
        <div class="center-sym">â˜½</div>
        <span class="center-line" id="centerLine1">South Indian</span>
        <span class="center-line" id="centerLine2">Vedic Chart</span>
      </div>
      <div class="cell" data-sign="Cancer">
        <span class="sign-abbr" data-sign="Cancer" tabindex="0" role="button">Cn</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Cancer"></div>
      </div>

      <div class="cell" data-sign="Capricorn">
        <span class="sign-abbr" data-sign="Capricorn" tabindex="0" role="button">Cp</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Capricorn"></div>
      </div>
      <div class="cell" data-sign="Leo">
        <span class="sign-abbr" data-sign="Leo" tabindex="0" role="button">Le</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Leo"></div>
      </div>

      <div class="cell" data-sign="Sagittarius">
        <span class="sign-abbr" data-sign="Sagittarius" tabindex="0" role="button">Sg</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Sagittarius"></div>
      </div>
      <div class="cell" data-sign="Scorpio">
        <span class="sign-abbr" data-sign="Scorpio" tabindex="0" role="button">Sc</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Scorpio"></div>
      </div>
      <div class="cell" data-sign="Libra">
        <span class="sign-abbr" data-sign="Libra" tabindex="0" role="button">Li</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Libra"></div>
      </div>
      <div class="cell" data-sign="Virgo">
        <span class="sign-abbr" data-sign="Virgo" tabindex="0" role="button">Vi</span>
        <span class="house-num"></span>
        <div class="planets-area" data-sign="Virgo"></div>
      </div>

    </div>
  </div>

  <!-- â”€â”€ Planet Bank â”€â”€ -->
  <div class="panel">
    <div class="panel-title" id="bankTitle">Planet Bank</div>
    <div class="planet-bank" id="planetBank" role="list" aria-label="Available planets">
      <span class="planet Lagna"   data-pid="Lagna"   tabindex="0" role="listitem">L</span>
      <span class="planet Sun"     data-pid="Sun"     tabindex="0" role="listitem">Su</span>
      <span class="planet Moon"    data-pid="Moon"    tabindex="0" role="listitem">Mo</span>
      <span class="planet Mars"    data-pid="Mars"    tabindex="0" role="listitem">Ma</span>
      <span class="planet Mercury" data-pid="Mercury" tabindex="0" role="listitem">Me</span>
      <span class="planet Jupiter" data-pid="Jupiter" tabindex="0" role="listitem">Ju</span>
      <span class="planet Venus"   data-pid="Venus"   tabindex="0" role="listitem">Ve</span>
      <span class="planet Saturn"  data-pid="Saturn"  tabindex="0" role="listitem">Sa</span>
      <span class="planet Rahu"    data-pid="Rahu"    tabindex="0" role="listitem">Ra</span>
      <span class="planet Ketu"    data-pid="Ketu"    tabindex="0" role="listitem">Ke</span>
    </div>
    <div class="tip-box" id="bankTip">
      Drag a planet into any sign cell. Tap a placed planet to set its degree &amp; retrograde. Double-tap to return it here.
    </div>
    <div class="persist-notice" id="persistNotice" aria-live="polite">âœ“ Chart saved</div>
    <div class="btn-row">
      <button class="btn" id="btnSigns">Hide Signs</button>
      <button class="btn" id="btnNums">Hide Numbers</button>
      <button class="btn danger" id="btnClear">Clear Chart</button>
    </div>
  </div>

  <!-- â”€â”€ AI Prompt â”€â”€ -->
  <div class="panel">
    <div class="panel-title" id="promptTitle">AI Reading Prompt</div>
    <p class="prompt-intro" id="promptIntro">
      Generate a ready-to-paste prompt for ChatGPT, Claude, or Gemini to get a full Vedic reading.
    </p>
    <div class="prompt-output" id="promptOutput" role="region" aria-label="Generated prompt" aria-live="polite"></div>
    <div class="btn-row">
      <button class="btn" id="btnGenPrompt">âœ¨ Generate</button>
      <button class="btn" id="btnCopyPrompt">ğŸ“‹ Copy</button>
    </div>
  </div>

  <!-- â”€â”€ Colour Legend â”€â”€ -->
  <div class="panel">
    <div class="panel-title" id="legendTitle">Planet Legend</div>
    <div class="legend" id="legendArea"></div>
  </div>

</div><!-- /app-wrap -->

<!-- Floating panels -->
<div class="tooltip"    id="tooltip"    role="tooltip"></div>

<div class="retro-panel" id="retroPanel" role="dialog" aria-modal="true" aria-labelledby="retroTitle">
  <div class="retro-panel-title" id="retroTitle">Planet</div>
  <label>
    <input type="checkbox" id="retroCheck">
    <span id="retroLabel">Retrograde (â„)</span>
  </label>
  <div class="deg-input-row">
    <label for="degInput">Degree</label>
    <input type="number" id="degInput" min="0" max="29.99" step="0.1" value="0">
    <span>Â°</span>
  </div>
  <button class="panel-close" id="retroClose">Done</button>
</div>

<div class="sign-panel" id="signPanel" role="dialog" aria-modal="true" aria-labelledby="spName">
  <strong id="spName"></strong>
  <hr>
  <div id="spBody"></div>
  <button class="panel-close" id="spClose">Close</button>
</div>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATIC DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SIGNS = [
  'Aries','Taurus','Gemini','Cancer','Leo','Virgo',
  'Libra','Scorpio','Sagittarius','Capricorn','Aquarius','Pisces'
];

const ALL_PIDS = [
  'Lagna','Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'
];

const PLANET_COLORS = {
  Lagna:'#8b6914', Sun:'#e8930e', Moon:'#6e7d85', Mars:'#c0392b',
  Mercury:'#219a52', Jupiter:'#d4720e', Venus:'#c4177a',
  Saturn:'#4a5bb0', Rahu:'#4e6a76', Ketu:'#6d4c3e'
};

const NAKSH = [
  {name:'Ashwini',             lord:'Ketu',    kw:'Speed, Healing, Initiative'},
  {name:'Bharani',             lord:'Venus',   kw:'Transformation, Patience, Sacrifice'},
  {name:'Krittika',            lord:'Sun',     kw:'Purification, Leadership, Protection'},
  {name:'Rohini',              lord:'Moon',    kw:'Growth, Fertility, Creativity'},
  {name:'Mrigashira',          lord:'Mars',    kw:'Curiosity, Searching, Wandering'},
  {name:'Ardra',               lord:'Rahu',    kw:'Intensity, Storm, Renewal'},
  {name:'Punarvasu',           lord:'Jupiter', kw:'Renewal, Nourishment, Return'},
  {name:'Pushya',              lord:'Saturn',  kw:'Nourishment, Protection, Spirituality'},
  {name:'Ashlesha',            lord:'Mercury', kw:'Intuition, Mysticism, Clinging'},
  {name:'Magha',               lord:'Ketu',    kw:'Authority, Ancestors, Legacy'},
  {name:'Purva Phalguni',      lord:'Venus',   kw:'Enjoyment, Luxury, Romance'},
  {name:'Uttara Phalguni',     lord:'Sun',     kw:'Support, Union, Philanthropy'},
  {name:'Hasta',               lord:'Moon',    kw:'Skill, Dexterity, Craftsmanship'},
  {name:'Chitra',              lord:'Mars',    kw:'Artistry, Beauty, Architecture'},
  {name:'Swati',               lord:'Rahu',    kw:'Independence, Movement, Adaptability'},
  {name:'Vishakha',            lord:'Jupiter', kw:'Purpose, Determination, Achievement'},
  {name:'Anuradha',            lord:'Saturn',  kw:'Devotion, Friendship, Success'},
  {name:'Jyeshtha',            lord:'Mercury', kw:'Seniority, Protection, Power'},
  {name:'Moola',               lord:'Ketu',    kw:'Foundation, Destruction, Research'},
  {name:'Purva Ashadha',       lord:'Venus',   kw:'Invincibility, Persistence, Water'},
  {name:'Uttara Ashadha',      lord:'Sun',     kw:'Victory, Dharma, Leadership'},
  {name:'Shravana',            lord:'Moon',    kw:'Listening, Learning, Wisdom'},
  {name:'Dhanishta',           lord:'Mars',    kw:'Wealth, Rhythm, Celebration'},
  {name:'Shatabhisha',         lord:'Rahu',    kw:'Healing, Mysticism, Hidden Knowledge'},
  {name:'Purva Bhadrapada',    lord:'Jupiter', kw:'Transformation, Spiritual Fire'},
  {name:'Uttara Bhadrapada',   lord:'Saturn',  kw:'Stability, Prosperity, Universal Love'},
  {name:'Revati',              lord:'Mercury', kw:'Nourishment, Protection, Completion'}
];

const PLANET_RULES = {
  Sun:['Leo'], Moon:['Cancer'], Mars:['Aries','Scorpio'],
  Mercury:['Gemini','Virgo'], Jupiter:['Sagittarius','Pisces'],
  Venus:['Taurus','Libra'], Saturn:['Capricorn','Aquarius'],
  Rahu:['Aquarius'], Ketu:['Scorpio']
};

const EXALTATION = {
  Sun:'Aries', Moon:'Taurus', Mars:'Capricorn', Mercury:'Virgo',
  Jupiter:'Cancer', Venus:'Pisces', Saturn:'Libra', Rahu:'Taurus', Ketu:'Scorpio'
};

const DEBILITATION = {
  Sun:'Libra', Moon:'Scorpio', Mars:'Cancer', Mercury:'Pisces',
  Jupiter:'Capricorn', Venus:'Virgo', Saturn:'Aries', Rahu:'Scorpio', Ketu:'Taurus'
};

const SIGN_DATA = {
  Aries:       {kw:'Initiation, Action, Energy',            ruler:'Mars',          el:'Fire',  mod:'Cardinal', sym:'â™ˆ'},
  Taurus:      {kw:'Stability, Sensuality, Comfort',        ruler:'Venus',         el:'Earth', mod:'Fixed',    sym:'â™‰'},
  Gemini:      {kw:'Communication, Intellect, Versatility', ruler:'Mercury',       el:'Air',   mod:'Dual',     sym:'â™Š'},
  Cancer:      {kw:'Nurturing, Emotion, Home',              ruler:'Moon',          el:'Water', mod:'Cardinal', sym:'â™‹'},
  Leo:         {kw:'Creativity, Leadership, Royalty',       ruler:'Sun',           el:'Fire',  mod:'Fixed',    sym:'â™Œ'},
  Virgo:       {kw:'Service, Analysis, Health',             ruler:'Mercury',       el:'Earth', mod:'Dual',     sym:'â™'},
  Libra:       {kw:'Harmony, Relationships, Justice',       ruler:'Venus',         el:'Air',   mod:'Cardinal', sym:'â™'},
  Scorpio:     {kw:'Transformation, Secrecy, Intensity',    ruler:'Mars / Ketu',   el:'Water', mod:'Fixed',    sym:'â™'},
  Sagittarius: {kw:'Philosophy, Exploration, Wisdom',       ruler:'Jupiter',       el:'Fire',  mod:'Dual',     sym:'â™'},
  Capricorn:   {kw:'Discipline, Ambition, Structure',       ruler:'Saturn',        el:'Earth', mod:'Cardinal', sym:'â™‘'},
  Aquarius:    {kw:'Innovation, Humanitarianism',           ruler:'Saturn / Rahu', el:'Air',   mod:'Fixed',    sym:'â™’'},
  Pisces:      {kw:'Imagination, Spirituality, Compassion', ruler:'Jupiter / Ketu',el:'Water', mod:'Dual',     sym:'â™“'}
};

const HOUSE_KW = {
  1:'Self, Personality, Body, Health',
  2:'Wealth, Family, Speech, Values',
  3:'Siblings, Courage, Communication',
  4:'Mother, Home, Land, Inner Peace',
  5:'Children, Creativity, Intelligence',
  6:'Enemies, Debts, Disease, Service',
  7:'Marriage, Partnerships, Spouse',
  8:'Longevity, Occult, Transformation',
  9:'Father, Dharma, Fortune, Guru',
  10:'Career, Status, Reputation',
  11:'Gains, Friends, Ambitions',
  12:'Losses, Moksha, Foreign Lands'
};

/* â”€â”€ Translations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const TRANS = {
  en: {
    title:       'South Indian Vedic Chart',
    subtitle:    'Drag planets Â· tap to edit Â· double-tap to remove',
    bankTitle:   'Planet Bank',
    bankTip:     'Drag a planet into any sign cell. Tap a placed planet to set its degree & retrograde. Double-tap to return it here.',
    promptTitle: 'AI Reading Prompt',
    promptIntro: 'Generate a ready-to-paste prompt for ChatGPT, Claude, or Gemini to get a full Vedic reading.',
    legendTitle: 'Planet Legend',
    hideSigns: 'Hide Signs',  showSigns: 'Show Signs',
    hideNums:  'Hide Numbers', showNums: 'Show Numbers',
    clearChart:'Clear Chart',
    retroLabel:'Retrograde (â„)',
    done:'Done', close:'Close',
    nakshatra:'Nakshatra', pada:'Pada', house:'House',
    houseKw:'House', signKw:'Keywords',
    ruler:'Ruler', element:'Element', modality:'Modality',
    lordOf:'Lord of', houseLord:'House Lordship',
    noLagna:'(Place Lagna to see house numbers)',
    center1:'South Indian', center2:'Vedic Chart',
    exalted:'Exalted â†‘', debil:'Debilitated â†“', own:'Own Sign',
    pnames:{
      Lagna:'Lagna', Sun:'Sun', Moon:'Moon', Mars:'Mars',
      Mercury:'Mercury', Jupiter:'Jupiter', Venus:'Venus',
      Saturn:'Saturn', Rahu:'Rahu', Ketu:'Ketu'
    },
    psym:{
      Lagna:'L', Sun:'Su', Moon:'Mo', Mars:'Ma',
      Mercury:'Me', Jupiter:'Ju', Venus:'Ve',
      Saturn:'Sa', Rahu:'Ra', Ketu:'Ke'
    },
    snames:{
      Aries:'Aries', Taurus:'Taurus', Gemini:'Gemini', Cancer:'Cancer',
      Leo:'Leo', Virgo:'Virgo', Libra:'Libra', Scorpio:'Scorpio',
      Sagittarius:'Sagittarius', Capricorn:'Capricorn', Aquarius:'Aquarius', Pisces:'Pisces'
    },
    ssym:{
      Aries:'Ar', Taurus:'Ta', Gemini:'Ge', Cancer:'Cn', Leo:'Le',
      Virgo:'Vi', Libra:'Li', Scorpio:'Sc', Sagittarius:'Sg',
      Capricorn:'Cp', Aquarius:'Aq', Pisces:'Pi'
    },
    hn:{
      1:'1st House',2:'2nd House',3:'3rd House',4:'4th House',
      5:'5th House',6:'6th House',7:'7th House',8:'8th House',
      9:'9th House',10:'10th House',11:'11th House',12:'12th House'
    }
  },
  te: {
    title:       'à°¦à°•à±à°·à°¿à°£ à°­à°¾à°°à°¤à±€à°¯ à°µà±‡à°¦ à°œà±à°¯à±‹à°¤à°¿à°·à±à°¯ à°šà°¾à°°à±à°Ÿà±',
    subtitle:    'à°—à±à°°à°¹à°¾à°²à°¨à± à°²à°¾à°—à°‚à°¡à°¿ Â· à°¨à±Šà°•à±à°•à°¿ à°¡à°¿à°—à±à°°à±€ à°¸à±†à°Ÿà± à°šà±‡à°¯à°‚à°¡à°¿ Â· à°°à±†à°‚à°¡à±à°¸à°¾à°°à±à°²à± à°¨à±Šà°•à±à°•à°¿ à°¤à±Šà°²à°—à°¿à°‚à°šà°‚à°¡à°¿',
    bankTitle:   'à°—à±à°°à°¹ à°¬à±à°¯à°¾à°‚à°•à±',
    bankTip:     'à°—à±à°°à°¹à°¾à°¨à±à°¨à°¿ à°°à°¾à°¶à°¿à°²à±‹à°•à°¿ à°²à°¾à°—à°‚à°¡à°¿. à°‰à°‚à°šà°¿à°¨ à°—à±à°°à°¹à°¾à°¨à±à°¨à°¿ à°¨à±Šà°•à±à°•à°¿ à°¡à°¿à°—à±à°°à±€/à°µà°•à±à°°à°¿ à°¸à±†à°Ÿà± à°šà±‡à°¯à°‚à°¡à°¿. à°°à±†à°‚à°¡à±à°¸à°¾à°°à±à°²à± à°¨à±Šà°•à±à°•à°¿ à°¤à°¿à°°à°¿à°—à°¿ à°ªà°‚à°ªà°‚à°¡à°¿.',
    promptTitle: 'AI à°°à±€à°¡à°¿à°‚à°—à± à°ªà±à°°à°¾à°‚à°ªà±à°Ÿà±',
    promptIntro: 'ChatGPT, Claude à°²à±‡à°¦à°¾ Gemini à°•à±‹à°¸à°‚ à°µà±‡à°¦ à°œà±à°¯à±‹à°¤à°¿à°·à±à°¯ à°°à±€à°¡à°¿à°‚à°—à± à°ªà±Šà°‚à°¦à±‡ à°ªà±à°°à°¾à°‚à°ªà±à°Ÿà± à°°à±‚à°ªà±Šà°‚à°¦à°¿à°‚à°šà°‚à°¡à°¿.',
    legendTitle: 'à°—à±à°°à°¹ à°µà°¿à°µà°°à°¾à°²à±',
    hideSigns: 'à°°à°¾à°¶à±à°²à°¨à± à°¦à°¾à°šà±', showSigns: 'à°°à°¾à°¶à±à°²à°¨à± à°šà±‚à°ªà±',
    hideNums:  'à°¨à°‚à°¬à°°à±à°²à°¨à± à°¦à°¾à°šà±', showNums: 'à°¨à°‚à°¬à°°à±à°²à°¨à± à°šà±‚à°ªà±',
    clearChart:'à°šà°¾à°°à±à°Ÿà± à°•à±à°²à°¿à°¯à°°à±',
    retroLabel:'à°µà°•à±à°°à°¿ (â„)',
    done:'à°¸à°°à±‡', close:'à°®à±‚à°¸à°¿à°µà±‡à°¯à°¿',
    nakshatra:'à°¨à°•à±à°·à°¤à±à°°à°‚', pada:'à°ªà°¾à°¦', house:'à°‡à°²à±à°²à±',
    houseKw:'à°‡à°‚à°Ÿà°¿ à°•à±€à°µà°°à±à°¡à±à°¸à±', signKw:'à°°à°¾à°¶à°¿ à°•à±€à°µà°°à±à°¡à±à°¸à±',
    ruler:'à°ªà°¾à°²à°• à°—à±à°°à°¹à°‚', element:'à°®à±‚à°²à°•à°‚', modality:'à°®à±‹à°¡à°¾à°²à°¿à°Ÿà±€',
    lordOf:'à°…à°§à°¿à°ªà°¤à°¿', houseLord:'à°‡à°‚à°Ÿà°¿ à°†à°§à°¿à°ªà°¤à±à°¯à°‚',
    noLagna:'(à°‡à°‚à°Ÿà°¿ à°¨à°‚à°¬à°°à±à°²à± à°šà±‚à°¡à°Ÿà°¾à°¨à°¿à°•à°¿ à°²à°—à±à°¨à°¾à°¨à°¿ à°‰à°‚à°šà°‚à°¡à°¿)',
    center1:'à°¦à°•à±à°·à°¿à°£ à°­à°¾à°°à°¤à±€à°¯', center2:'à°œà±à°¯à±‹à°¤à°¿à°·à±à°¯ à°šà°¾à°°à±à°Ÿà±',
    exalted:'à°‰à°šà±à°š â†‘', debil:'à°¨à±€à°š â†“', own:'à°¸à±à°µà°—à±à°°à°¹à°‚',
    pnames:{
      Lagna:'à°²à°—à±à°¨', Sun:'à°¸à±‚à°°à±à°¯à±à°¡à±', Moon:'à°šà°‚à°¦à±à°°à±à°¡à±', Mars:'à°•à±à°œà±à°¡à±',
      Mercury:'à°¬à±à°§à±à°¡à±', Jupiter:'à°—à±à°°à±à°¡à±', Venus:'à°¶à±à°•à±à°°à±à°¡à±',
      Saturn:'à°¶à°¨à°¿', Rahu:'à°°à°¾à°¹à±à°µà±', Ketu:'à°•à±‡à°¤à±à°µà±'
    },
    psym:{
      Lagna:'à°²', Sun:'à°¸à±‚', Moon:'à°šà°‚', Mars:'à°•à±',
      Mercury:'à°¬à±', Jupiter:'à°—à±', Venus:'à°¶à±à°•à±à°°',
      Saturn:'à°¶à°¨à°¿', Rahu:'à°°à°¾', Ketu:'à°•à±‡'
    },
    snames:{
      Aries:'à°®à±‡à°·à°‚', Taurus:'à°µà±ƒà°·à°­à°‚', Gemini:'à°®à°¿à°¥à±à°¨à°‚', Cancer:'à°•à°°à±à°•à°¾à°Ÿà°•à°‚',
      Leo:'à°¸à°¿à°‚à°¹à°‚', Virgo:'à°•à°¨à±à°¯', Libra:'à°¤à±à°²', Scorpio:'à°µà±ƒà°¶à±à°šà°¿à°•à°‚',
      Sagittarius:'à°§à°¨à±à°¸à±à°¸à±', Capricorn:'à°®à°•à°°à°‚', Aquarius:'à°•à±à°‚à°­à°‚', Pisces:'à°®à±€à°¨à°‚'
    },
    ssym:{
      Aries:'à°®à±‡', Taurus:'à°µà±ƒ', Gemini:'à°®à°¿', Cancer:'à°•', Leo:'à°¸à°¿à°‚',
      Virgo:'à°•à°¨à±à°¯', Libra:'à°¤à±', Scorpio:'à°µà±ƒà°¶à±à°šà°¿', Sagittarius:'à°§à°¨à±',
      Capricorn:'à°®à°•', Aquarius:'à°•à±à°‚', Pisces:'à°®à±€'
    },
    hn:{
      1:'1à°µ à°‡à°²à±à°²à±',2:'2à°µ à°‡à°²à±à°²à±',3:'3à°µ à°‡à°²à±à°²à±',4:'4à°µ à°‡à°²à±à°²à±',
      5:'5à°µ à°‡à°²à±à°²à±',6:'6à°µ à°‡à°²à±à°²à±',7:'7à°µ à°‡à°²à±à°²à±',8:'8à°µ à°‡à°²à±à°²à±',
      9:'9à°µ à°‡à°²à±à°²à±',10:'10à°µ à°‡à°²à±à°²à±',11:'11à°µ à°‡à°²à±à°²à±',12:'12à°µ à°‡à°²à±à°²à±'
    }
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lang         = 'en';
let lagnaSign    = null;
let signsHidden  = false;
let numsHidden   = false;
let planetData   = {};     // { pid: { sign, degree, retro } }

let activePid    = null;   // planet currently open in retro panel
let dragState    = null;
let lastDragEndTime = 0;

let persistTimer = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const T  = () => TRANS[lang];
const $  = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

/** House number 1â€“12, always requires explicit lagnaSign */
function houseNum(sign, ls) {
  if (!ls) return null;
  const a = SIGNS.indexOf(ls);
  const s = SIGNS.indexOf(sign);
  if (a < 0 || s < 0) return null;
  return (s - a + 12) % 12 + 1;
}

function getNakshatra(sign, deg) {
  const si = SIGNS.indexOf(sign);
  if (si < 0) return { name:'?', kw:'', pada:1, lord:'?' };
  const total  = si * 30 + deg;
  const nLen   = 360 / 27;
  let   ni     = Math.floor(total / nLen);
  if (ni >= 27) ni = 26;
  const pada   = Math.min(4, Math.floor((total % nLen) / (nLen / 4)) + 1);
  return { ...NAKSH[ni], pada };
}

function getStrength(pid, sign) {
  if (!pid || pid === 'Lagna') return null;
  if (EXALTATION[pid]   === sign) return 'exalted';
  if (DEBILITATION[pid] === sign) return 'debilitated';
  if ((PLANET_RULES[pid] || []).includes(sign)) return 'own';
  return null;
}

/* Position a floating panel so it stays inside the viewport */
function positionFloating(el, anchorX, anchorY) {
  // must be visible to measure
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  // measure after a frame so the element is rendered
  requestAnimationFrame(() => {
    const w = el.offsetWidth  || 220;
    const h = el.offsetHeight || 140;
    let lx = anchorX + 14;
    let ly = anchorY - h - 10;
    if (lx + w > vw - 8)  lx = anchorX - w - 14;
    if (lx < 8)           lx = 8;
    if (ly < 8)           ly = anchorY + 28;
    if (ly + h > vh - 8)  ly = vh - h - 8;
    el.style.left = lx + 'px';
    el.style.top  = ly + 'px';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD / REFRESH PLANET ELEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildPlanet(pid) {
  const el = document.createElement('span');
  el.className = `planet ${pid}`;
  el.dataset.pid = pid;
  el.setAttribute('tabindex', '0');
  el.setAttribute('role', 'button');
  refreshChip(el);
  return el;
}

function refreshChip(el) {
  const pid = el.dataset.pid;
  const t   = T();
  const sym = t.psym[pid] || pid.slice(0, 2);
  const d   = planetData[pid];
  let html  = sym;
  if (d) {
    html += `<span class="deg-label" aria-hidden="true">${d.degree.toFixed(1)}Â°</span>`;
    if (d.retro) html += `<span class="retro-mark" title="Retrograde">R</span>`;
  }
  el.innerHTML = html;
  const pname = t.pnames[pid] || pid;
  el.setAttribute('aria-label',
    `${pname}${d ? ' ' + d.degree.toFixed(1) + 'Â°' : ''}${d?.retro ? ' retrograde' : ''}`
  );
}

function refreshAllChips() {
  document.querySelectorAll('.planet').forEach(el => refreshChip(el));
}

/* Rebuild the bank: show only planets not currently in chart */
function rebuildBank() {
  const bank    = $('#planetBank');
  const inChart = new Set(
    [...$$('.planets-area .planet')].map(el => el.dataset.pid)
  );
  [...bank.querySelectorAll('.planet')].forEach(el => el.remove());
  ALL_PIDS.forEach(pid => {
    if (!inChart.has(pid)) bank.appendChild(buildPlanet(pid));
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOUSE NUMBERS & SIGN LABELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateHouseNums() {
  $$('.cell[data-sign]').forEach(cell => {
    const el = cell.querySelector('.house-num');
    const n  = houseNum(cell.dataset.sign, lagnaSign);
    el.textContent = (n && !numsHidden) ? n : '';
  });
}

function updateSignLabels() {
  const t = T();
  $$('.sign-abbr').forEach(el => {
    const sign = el.dataset.sign;
    el.textContent = t.ssym[sign] || sign.slice(0, 2);
    el.classList.toggle('hidden', signsHidden);
    el.setAttribute('tabindex', signsHidden ? '-1' : '0');
    el.setAttribute('aria-label', `${t.snames[sign] || sign} sign info`);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLANET COLOUR LEGEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildLegend() {
  const t    = T();
  const area = $('#legendArea');
  area.innerHTML = '';
  ALL_PIDS.forEach(pid => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    const dot  = document.createElement('div');
    dot.className = 'legend-dot';
    dot.style.background = PLANET_COLORS[pid];
    if (pid === 'Lagna') {
      dot.style.background = 'transparent';
      dot.style.border = `2px solid ${PLANET_COLORS.Lagna}`;
    }
    const lbl = document.createElement('span');
    lbl.textContent = t.pnames[pid];
    item.appendChild(dot);
    item.appendChild(lbl);
    area.appendChild(item);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLACE / RETURN PLANETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function movePlanetToSign(pid, targetSign) {
  // Remove from wherever it currently is
  document.querySelector(`.planet[data-pid="${pid}"]`)?.remove();

  if (pid === 'Lagna') lagnaSign = targetSign;

  if (!planetData[pid]) {
    planetData[pid] = {
      sign:   targetSign,
      degree: parseFloat((Math.random() * 29).toFixed(2)),
      retro:  false
    };
  } else {
    planetData[pid].sign = targetSign;
  }

  const area = $(`.planets-area[data-sign="${targetSign}"]`);
  if (area) area.appendChild(buildPlanet(pid));

  updateHouseNums();
  saveState();
}

function returnPlanetToBank(pid) {
  document.querySelector(`.planets-area .planet[data-pid="${pid}"]`)?.remove();
  delete planetData[pid];
  if (pid === 'Lagna') { lagnaSign = null; updateHouseNums(); }
  rebuildBank();
  saveState();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAG & DROP  (Pointer Events)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ghost = $('#drag-ghost');

document.addEventListener('pointerdown',  onDown,  { passive: false });
document.addEventListener('pointermove',  onMove,  { passive: false });
document.addEventListener('pointerup',    onUp,    { passive: false });
document.addEventListener('pointercancel',onCancel);

function onDown(e) {
  if (dragState) return;
  const el = e.target.closest('.planet');
  if (!el) return;
  e.preventDefault();
  const pid     = el.dataset.pid;
  const inChart = !!el.closest('.planets-area');
  const inBank  = !!el.closest('#planetBank');
  if (!inChart && !inBank) return;
  dragState = {
    pid, pointerId: e.pointerId, sourceEl: el,
    startX: e.clientX, startY: e.clientY,
    moved: false, degMode: false, dirLocked: false,
    initDeg: 0, inChart, ghostShown: false
  };
}

function onMove(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  e.preventDefault();
  const dx = e.clientX - dragState.startX;
  const dy = e.clientY - dragState.startY;
  if (Math.hypot(dx, dy) < 5) return;
  dragState.moved = true;

  // First movement: decide direction (vertical = degree-scrub, horizontal = drag)
  if (dragState.inChart && !dragState.dirLocked) {
    dragState.degMode   = Math.abs(dy) > Math.abs(dx);
    dragState.dirLocked = true;
    dragState.initDeg   = planetData[dragState.pid]?.degree ?? 0;
  }

  if (dragState.degMode) {
    const raw = dragState.initDeg + (dragState.startY - e.clientY) / 22;
    const deg = Math.max(0, Math.min(29.99, parseFloat(raw.toFixed(2))));
    if (planetData[dragState.pid]) {
      planetData[dragState.pid].degree = deg;
      refreshChip(dragState.sourceEl);
      showTooltip(dragState.pid, e.clientX, e.clientY);
    }
    return;
  }

  // Positional drag
  if (!dragState.ghostShown) {
    dragState.ghostShown = true;
    dragState.sourceEl.classList.add('dragging');
    dragState.sourceEl.style.pointerEvents = 'none';
    hideAllPanels();
    const clone = dragState.sourceEl.cloneNode(true);
    clone.style.transform = 'none';
    clone.style.pointerEvents = 'none';
    ghost.innerHTML = '';
    ghost.appendChild(clone);
    ghost.style.display = 'block';
  }
  const w = ghost.offsetWidth  || 50;
  const h = ghost.offsetHeight || 26;
  ghost.style.left = (e.clientX - w / 2) + 'px';
  ghost.style.top  = (e.clientY - h / 2) + 'px';

  $$('.cell.drop-active, .planet-bank.drop-active').forEach(el => el.classList.remove('drop-active'));
  getDropTarget(e.clientX, e.clientY)?.classList.add('drop-active');
}

function onUp(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  e.preventDefault();

  // Snapshot before any mutation
  const { pid, moved, degMode, inChart } = dragState;
  cleanupDrag();

  if (!moved) {
    // Pure tap on a placed planet â†’ open retro panel
    if (inChart && planetData[pid]) {
      showRetroPanel(pid, e.clientX, e.clientY);
    }
    dragState = null;
    return;
  }

  if (degMode) {
    saveState();
    dragState = null;
    return;
  }

  lastDragEndTime = Date.now();
  const target = getDropTarget(e.clientX, e.clientY);
  dragState = null;

  if (!target) return;
  if (target.id === 'planetBank')  returnPlanetToBank(pid);
  else if (target.dataset.sign)   movePlanetToSign(pid, target.dataset.sign);
}

function onCancel(e) {
  if (!dragState || e.pointerId !== dragState.pointerId) return;
  cleanupDrag();
  dragState = null;
  hideTooltip();
}

function cleanupDrag() {
  ghost.style.display = 'none';
  ghost.innerHTML     = '';
  $$('.cell.drop-active, .planet-bank.drop-active').forEach(el => el.classList.remove('drop-active'));
  if (dragState?.sourceEl) {
    dragState.sourceEl.classList.remove('dragging');
    dragState.sourceEl.style.pointerEvents = '';
  }
  hideTooltip();
}

function getDropTarget(x, y) {
  for (const el of document.elementsFromPoint(x, y)) {
    const cell = el.closest('.cell[data-sign]');
    if (cell) return cell;
    if (el.id === 'planetBank' || el.closest('#planetBank')) return $('#planetBank');
  }
  return null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOUBLE-TAP TO RETURN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lastTap = { pid: null, time: 0 };

document.addEventListener('click', e => {
  if (Date.now() - lastDragEndTime < 400) return;
  const el = e.target.closest('.planet');
  if (!el || !el.closest('.planets-area')) return;
  const pid = el.dataset.pid;
  const now = Date.now();
  if (lastTap.pid === pid && now - lastTap.time < 420) {
    returnPlanetToBank(pid);
    hideAllPanels();
    lastTap = { pid: null, time: 0 };
  } else {
    lastTap = { pid, time: now };
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOOLTIP (desktop hover)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tooltipEl = $('#tooltip');

document.addEventListener('mousemove', e => {
  if (dragState) return;
  const el = e.target.closest('.planet');
  if (el && el.closest('.planets-area') && planetData[el.dataset.pid]) {
    showTooltip(el.dataset.pid, e.clientX, e.clientY);
  } else if (!e.target.closest('#tooltip')) {
    hideTooltip();
  }
});

function showTooltip(pid, x, y) {
  const t   = T();
  const d   = planetData[pid];
  if (!d) return;
  const nak = getNakshatra(d.sign, d.degree);
  const str = getStrength(pid, d.sign);
  const hn  = houseNum(d.sign, lagnaSign);

  const strColor = str === 'exalted' ? 'var(--green)' : str === 'debilitated' ? 'var(--red)' : 'var(--gold)';
  const strLabel = str === 'exalted' ? t.exalted : str === 'debilitated' ? t.debil : t.own;

  let html = `<strong>${t.pnames[pid] || pid}</strong>`;
  html += `<div class="trow">${d.degree.toFixed(2)}Â° ${t.snames[d.sign] || d.sign}`;
  if (hn) html += ` &nbsp;Â·&nbsp; ${t.hn[hn]}`;
  html += `</div>`;
  if (str) html += `<div class="trow t-strength" style="color:${strColor}">â¬¥ ${strLabel}</div>`;
  if (d.retro) html += `<div class="trow" style="color:var(--red)">â„ Retrograde</div>`;
  html += `<hr>`;
  html += `<div class="trow"><span>${t.nakshatra}: </span>${nak.name} (${t.pada} ${nak.pada})</div>`;
  html += `<div class="trow"><span>Lord: </span>${nak.lord}</div>`;
  html += `<div class="trow"><span>Keywords: </span>${nak.kw}</div>`;

  if (lagnaSign && PLANET_RULES[pid]) {
    html += `<hr><div style="color:var(--gold);font-family:'Cinzel',serif;font-size:0.7rem;margin-bottom:3px">${t.houseLord}</div>`;
    PLANET_RULES[pid].forEach(rs => {
      const n = houseNum(rs, lagnaSign);
      if (!n) return;
      html += `<div class="trow">${t.lordOf} ${t.hn[n]}: <span>${HOUSE_KW[n]}</span></div>`;
    });
  }

  tooltipEl.innerHTML = html;
  tooltipEl.classList.add('visible');
  positionFloating(tooltipEl, x, y);
}

function hideTooltip() {
  tooltipEl.classList.remove('visible');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGN INFO PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const signPanelEl = $('#signPanel');

function showSignPanel(sign, x, y) {
  hideAllPanels();
  const t  = T();
  const sd = SIGN_DATA[sign];
  const hn = houseNum(sign, lagnaSign);

  $('#spName').textContent = `${sd?.sym || ''} ${t.snames[sign] || sign}`;
  let body = '';
  if (hn) {
    body += `<div><strong>${t.house} ${hn}:</strong> ${t.hn[hn]}</div>`;
    body += `<div><strong>${t.houseKw}:</strong> ${HOUSE_KW[hn]}</div><hr>`;
  } else {
    body += `<div style="color:var(--text-muted);font-style:italic">${t.noLagna}</div><hr>`;
  }
  if (sd) {
    body += `<div><strong>${t.signKw}:</strong> ${sd.kw}</div>`;
    body += `<div><strong>${t.ruler}:</strong> ${sd.ruler}</div>`;
    body += `<div><strong>${t.element}:</strong> ${sd.el} &nbsp;|&nbsp; <strong>${t.modality}:</strong> ${sd.mod}</div>`;
  }
  $('#spBody').innerHTML = body;

  signPanelEl.classList.add('visible');
  $('#overlay').classList.add('visible');
  positionFloating(signPanelEl, x, y);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RETROGRADE / DEGREE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const retroPanelEl = $('#retroPanel');
const retroCheck   = $('#retroCheck');
const degInput     = $('#degInput');

function showRetroPanel(pid, x, y) {
  hideAllPanels();
  activePid = pid;
  const t = T();
  $('#retroTitle').textContent   = t.pnames[pid] || pid;
  $('#retroLabel').textContent   = t.retroLabel;
  $('#retroClose').textContent   = t.done;
  retroCheck.checked = !!planetData[pid]?.retro;
  degInput.value     = (planetData[pid]?.degree ?? 0).toFixed(2);

  retroPanelEl.classList.add('visible');
  $('#overlay').classList.add('visible');
  positionFloating(retroPanelEl, x, y);
}

retroCheck.addEventListener('change', () => {
  if (!activePid || !planetData[activePid]) return;
  planetData[activePid].retro = retroCheck.checked;
  document.querySelector(`.planets-area .planet[data-pid="${activePid}"]`)
    && refreshChip(document.querySelector(`.planets-area .planet[data-pid="${activePid}"]`));
  saveState();
});

degInput.addEventListener('input', () => {
  if (!activePid || !planetData[activePid]) return;
  const v = Math.max(0, Math.min(29.99, parseFloat(degInput.value) || 0));
  planetData[activePid].degree = v;
  const chip = document.querySelector(`.planets-area .planet[data-pid="${activePid}"]`);
  if (chip) refreshChip(chip);
  saveState();
});

degInput.addEventListener('blur', () => {
  if (!activePid || !planetData[activePid]) return;
  const v = Math.max(0, Math.min(29.99, parseFloat(degInput.value) || 0));
  planetData[activePid].degree = v;
  degInput.value = v.toFixed(2);
  const chip = document.querySelector(`.planets-area .planet[data-pid="${activePid}"]`);
  if (chip) refreshChip(chip);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL CLOSE LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function hideAllPanels() {
  hideTooltip();
  signPanelEl.classList.remove('visible');
  retroPanelEl.classList.remove('visible');
  $('#overlay').classList.remove('visible');
  activePid = null;
}

$('#retroClose').addEventListener('click', hideAllPanels);
$('#retroClose').addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') hideAllPanels(); });
$('#spClose').addEventListener('click', hideAllPanels);
$('#spClose').addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') hideAllPanels(); });
$('#overlay').addEventListener('click', hideAllPanels);

// Close panels on outside tap (capture phase)
document.addEventListener('pointerdown', e => {
  if (!retroPanelEl.classList.contains('visible') &&
      !signPanelEl.classList.contains('visible')) return;
  if (e.target.closest('#retroPanel') ||
      e.target.closest('#signPanel')  ||
      e.target.closest('.sign-abbr')) return;
  hideAllPanels();
}, { capture: true });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIGN LABEL CLICK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bindSignLabels() {
  $$('.sign-abbr').forEach(el => {
    el.addEventListener('click', ev => {
      if (signsHidden) return;
      if (signPanelEl.classList.contains('visible')) { hideAllPanels(); return; }
      ev.stopPropagation();
      showSignPanel(el.dataset.sign, ev.clientX, ev.clientY);
    });
    el.addEventListener('keydown', ev => {
      if ((ev.key === 'Enter' || ev.key === ' ') && !signsHidden) {
        ev.preventDefault();
        const r = el.getBoundingClientRect();
        showSignPanel(el.dataset.sign, r.right, r.bottom);
      }
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('#btnSigns').addEventListener('click', () => {
  signsHidden = !signsHidden;
  $('#btnSigns').textContent = signsHidden ? T().showSigns : T().hideSigns;
  updateSignLabels();
});

$('#btnNums').addEventListener('click', () => {
  numsHidden = !numsHidden;
  $('#btnNums').textContent = numsHidden ? T().showNums : T().hideNums;
  updateHouseNums();
});

$('#btnClear').addEventListener('click', () => {
  $$('.planets-area .planet').forEach(el => el.remove());
  planetData  = {};
  lagnaSign   = null;
  signsHidden = false;
  numsHidden  = false;
  dragState   = null;
  ghost.style.display = 'none';
  rebuildBank();
  applyLang();
  $('#promptOutput').textContent = '';
  hideAllPanels();
  clearSaved();
});

$('#lang').addEventListener('change', e => {
  lang = e.target.value;
  document.documentElement.lang = lang;
  applyLang();
  hideAllPanels();
  saveState();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI PROMPT GENERATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('#btnGenPrompt').addEventListener('click', generatePrompt);

$('#btnCopyPrompt').addEventListener('click', async () => {
  const text = $('#promptOutput').textContent.trim();
  if (!text) return;
  try {
    await navigator.clipboard.writeText(text);
    showToast('âœ“ Copied to clipboard!');
  } catch {
    // fallback: select for manual copy
    const r = document.createRange();
    r.selectNodeContents($('#promptOutput'));
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(r);
    showToast('Text selected â€” press Ctrl+C / Cmd+C');
  }
});

function generatePrompt() {
  const t      = T();
  const placed = ALL_PIDS.filter(p => planetData[p]);
  if (!placed.length) { $('#promptOutput').textContent = ''; return; }

  const lagnaD = planetData['Lagna'];
  const lagnaLine = lagnaD
    ? `Lagna (Ascendant): ${lagnaD.sign} (${lagnaD.degree.toFixed(2)}Â°)`
    : 'Lagna: Not placed';

  const lines = ALL_PIDS
    .filter(p => p !== 'Lagna' && planetData[p])
    .map(pid => {
      const d   = planetData[pid];
      const nak = getNakshatra(d.sign, d.degree);
      const hn  = lagnaSign ? houseNum(d.sign, lagnaSign) : null;
      const str = getStrength(pid, d.sign);
      let ln = `${t.pnames[pid]}: ${d.sign} ${d.degree.toFixed(2)}Â° â€” ${nak.name} (Pada ${nak.pada}, Lord ${nak.lord})`;
      if (hn)  ln += `, ${t.hn[hn]}`;
      if (str) ln += ` [${str === 'exalted' ? 'EXALTED' : str === 'debilitated' ? 'DEBILITATED' : 'OWN SIGN'}]`;
      if (d.retro) ln += ' â„';
      return ln;
    });

  const prompt =
`I have a South Indian Vedic (Jyotisha) natal chart. Please analyze it using classical Vedic astrology (Parashari system).

â•â•â• PLANETARY POSITIONS â•â•â•
${lagnaLine}

${lines.join('\n')}

â•â•â• READING REQUEST â•â•â•
Please provide a detailed Vedic astrology reading covering: personality & appearance, health, career & livelihood, finances, relationships & marriage, family, spirituality, and major life themes.

Consider planetary dignities (exaltation/debilitation/own sign), house lordships, sign qualities, and conjunctions. Use traditional Vedic methods, not Western/Tropical astrology.`;

  $('#promptOutput').textContent = prompt;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer = null;
function showToast(msg) {
  const el = $('#copyToast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2400);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGUAGE / APPLY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyLang() {
  const t = T();
  document.documentElement.lang = lang;
  $('#appTitle').textContent    = t.title;
  $('#appSubtitle').textContent = t.subtitle;
  $('#bankTitle').textContent   = t.bankTitle;
  $('#bankTip').textContent     = t.bankTip;
  $('#promptTitle').textContent = t.promptTitle;
  $('#promptIntro').textContent = t.promptIntro;
  $('#legendTitle').textContent = t.legendTitle;
  $('#centerLine1').textContent = t.center1;
  $('#centerLine2').textContent = t.center2;
  $('#btnSigns').textContent    = signsHidden ? t.showSigns : t.hideSigns;
  $('#btnNums').textContent     = numsHidden  ? t.showNums  : t.hideNums;
  $('#btnClear').textContent    = t.clearChart;
  $('#retroLabel').textContent  = t.retroLabel;
  $('#retroClose').textContent  = t.done;
  $('#spClose').textContent     = t.close;
  updateSignLabels();
  updateHouseNums();
  refreshAllChips();
  rebuildBank();
  buildLegend();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSISTENCE  (localStorage)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STORAGE_KEY = 'vedic-south-v2';

function saveState() {
  clearTimeout(persistTimer);
  persistTimer = setTimeout(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ planetData, lagnaSign, lang }));
      const n = $('#persistNotice');
      n.classList.add('show');
      setTimeout(() => n.classList.remove('show'), 1800);
    } catch { /* storage unavailable */ }
  }, 400);
}

function clearSaved() {
  try { localStorage.removeItem(STORAGE_KEY); } catch { }
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const s = JSON.parse(raw);
    if (!s || typeof s !== 'object') return false;

    // language
    if (s.lang && TRANS[s.lang]) {
      lang = s.lang;
      $('#lang').value = lang;
    }

    // planet data â€” validate each entry
    if (s.planetData && typeof s.planetData === 'object') {
      planetData = {};
      for (const [pid, d] of Object.entries(s.planetData)) {
        if (!ALL_PIDS.includes(pid))      continue;
        if (!SIGNS.includes(d?.sign))     continue;
        const deg = parseFloat(d.degree);
        planetData[pid] = {
          sign:   d.sign,
          degree: isNaN(deg) ? 0 : Math.max(0, Math.min(29.99, deg)),
          retro:  !!d.retro
        };
      }
    }

    // lagnaSign â€” derive from Lagna planet, ignore separate stored value to avoid desync
    lagnaSign = planetData['Lagna']?.sign ?? null;

    return Object.keys(planetData).length > 0;
  } catch { return false; }
}

function restoreFromState() {
  for (const pid of ALL_PIDS) {
    const d = planetData[pid];
    if (!d) continue;
    const area = $(`.planets-area[data-sign="${d.sign}"]`);
    if (!area) continue;
    area.appendChild(buildPlanet(pid));
  }
  rebuildBank();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const hadSaved = loadState();
applyLang();          // sets language, labels, legend
bindSignLabels();     // attach event listeners to sign labels

if (hadSaved) {
  restoreFromState();   // place saved planets
}

updateHouseNums();

</script>
</body>
</html>
